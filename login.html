<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart HSR - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root { --primary-teal:#0ea5a1; --secondary-navy:#0b2b3a; --card-bg:#ffffff; --button-shadow:rgba(14,165,161,0.4); }
    * { box-sizing:border-box; }
    body {
      margin:0; font-family:'Tajawal',sans-serif;
      background:linear-gradient(180deg,#f7f9fb 0%,#f0f2f5 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden; padding:30px;
    }
    body::before{
      content:""; position:absolute; inset:0;
      background:url('Smart_HSR_Dashboard_Logo.svg') center center no-repeat;
      background-size:40%; opacity:.08; z-index:0;
    }
    .card{ width:380px; background:var(--card-bg); border-radius:24px;
      box-shadow:0 15px 40px rgba(10,20,50,0.15); padding:40px 30px;
      border:1px solid #e9ecef; position:relative; overflow:hidden; z-index:1; transition:all .3s ease; backdrop-filter:blur(4px);
    }
    .card:hover{ box-shadow:0 18px 45px rgba(14,165,161,0.2); }
    .card-header-line{ position:absolute; top:0; left:0; right:0; height:5px;
      background:linear-gradient(90deg,var(--primary-teal),var(--secondary-navy)); border-top-left-radius:24px; border-top-right-radius:24px;
    }
    .logo{ display:block; width:120px; margin:20px auto 15px; }
    h1{ margin:0 0 4px 0; text-align:center; font-size:28px; color:var(--secondary-navy); font-weight:900; }
    p.lead{ margin:0 0 25px 0; text-align:center; color:#6c757d; font-weight:500; font-size:16px; }
    .field{ margin-bottom:18px; }
    .field label{ display:block; margin-bottom:8px; color:var(--secondary-navy); font-size:14px; font-weight:600; }
    input[type="email"],input[type="password"]{
      width:100%; padding:14px 18px; border-radius:12px; border:1px solid #d4dce4; background:#f8f9fa; font-size:16px; outline:none;
      transition:border-color .3s, box-shadow .3s;
    }
    input:focus{ border-color:var(--primary-teal); box-shadow:0 0 0 3px rgba(14,165,161,0.1); background:#fff; }
    .btn{ width:100%; padding:14px; border-radius:12px; border:none; cursor:pointer; font-weight:700; font-size:17px; transition:all .3s ease; display:flex; align-items:center; justify-content:center; }
    .btn-primary{ background:linear-gradient(90deg,var(--primary-teal),#0b7285); color:#fff; box-shadow:0 10px 20px var(--button-shadow); }
    .btn-primary:hover:not(:disabled){ transform:translateY(-2px); box-shadow:0 12px 25px var(--button-shadow); background:linear-gradient(90deg,#0b7285,var(--primary-teal)); }
    .message{ text-align:center; margin-top:15px; font-weight:600; font-size:15px; }
    .error{ color:#dc3545; } .success{ color:#198754; }
    .muted{ font-size:13px; color:#7b8a90; text-align:center; margin-top:15px; }
    .loading-spinner{ border:3px solid rgba(255,255,255,.3); border-top:3px solid white; border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; margin-left:10px; }
    @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    @media (max-width:420px){ .card{ width:95%; padding:30px 20px; } .logo{ width:90px; } }

    /* Snackbar */
    #snackbar {
      visibility: hidden; min-width: 260px; background: var(--primary-teal);
      color: #fff; text-align: center; border-radius: 12px;
      padding: 16px; position: fixed; top: 30px; right: 30px;
      z-index: 9999; font-weight:700; box-shadow:0 8px 25px rgba(14,165,161,0.4);
      opacity:0; transform:translateY(-15px); transition:all .4s ease;
    }
    #snackbar.show {
      visibility: visible; opacity:1; transform:translateY(0);
    }
  </style>
</head>
<body>
  <div id="snackbar">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­</div>

  <div class="card" role="main">
    <div class="card-header-line"></div>
    <img src="Smart_HSR_Dashboard_Logo.svg" alt="Ø´Ø¹Ø§Ø± Smart HSR" class="logo">
    <h1>Smart HSR</h1>
    <p class="lead">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©</p>

    <form id="loginForm" onsubmit="event.preventDefault(); signInWithEmail();">
      <div class="field">
        <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ù„Ù…Ø¹ØªÙ…Ø¯):</label>
        <input id="email" type="email" placeholder="example@smart-hsr.com" required />
      </div>
      <div class="field">
        <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
        <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø³Ø±ÙŠØ©" required />
      </div>
      <button type="submit" id="loginButton" class="btn btn-primary" style="margin-top:10px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>

    <div id="msg" class="message"></div>
    <div class="muted">Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø®ØµØµ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠÙŠÙ† ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙŠÙ† ÙÙ‚Ø·.</div>
  </div>

<script type="module">
  import { firebaseConfig } from './firebase-config.js';
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { 
    getAuth, signInWithEmailAndPassword, onAuthStateChanged,
    setPersistence, browserLocalPersistence 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  await setPersistence(auth, browserLocalPersistence);

  const loginButton = document.getElementById('loginButton');
  const msgBox = document.getElementById('msg');

  function msg(text, type='') {
    msgBox.innerText = text;
    msgBox.className = 'message ' + type;
  }

  function showSnackbar(text) {
    const x = document.getElementById("snackbar");
    x.textContent = text;
    x.classList.add("show");
    setTimeout(() => x.classList.remove("show"), 2000);
  }

  // âœ… Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø°ÙƒÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
  async function redirectUser(user) {
    try {
      const snap = await getDoc(doc(db, 'users', user.uid));
      if (!snap.exists()) {
        console.warn("âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ø³Ø¬Ù„ ÙÙŠ FirestoreØŒ ØªÙˆØ¬ÙŠÙ‡ Ø§ÙØªØ±Ø§Ø¶ÙŠ.");
        return window.location.href = "index.html";
      }

      const data = snap.data();
      const role = (data.role || "").toLowerCase();

      if (role === 'admin') {
        console.log("ğŸ‘‘ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ù„Ù‰ admin.html");
        window.location.href = "admin.html";
      } else if (role === 'inspector' || role === 'contractor') {
        console.log("ğŸ‘·â€â™‚ï¸ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ index.html");
        window.location.href = "index.html";
      } else {
        console.warn("â” Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ:", role);
        window.location.href = "index.html";
      }
    } catch (e) {
      console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ±:", e);
      window.location.href = "index.html";
    }
  }

  // âœ… ØªØ­Ù‚Ù‚ Ø¯Ø§Ø¦Ù… Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  onAuthStateChanged(auth, (user) => {
    if (user) redirectUser(user);
  });

  // ğŸš€ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„
  window.signInWithEmail = async function() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) {
      msg('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£ÙˆÙ„Ø§Ù‹.', 'error');
      return;
    }

    loginButton.disabled = true;
    loginButton.innerHTML = `<div class="loading-spinner"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...`;

    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      localStorage.setItem('userEmail', cred.user?.email || '');
      msg('');
      showSnackbar("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­");
      // â³ Ù†Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø© Ø¨Ø³ÙŠØ·Ø© Ø­ØªÙ‰ ØªÙØ¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ± Ù…Ù† Firestore
      setTimeout(() => redirectUser(cred.user), 800);
    } catch (e) {
      console.error(e);
      let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.';
      if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password')
        errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
      else if (e.code === 'auth/too-many-requests')
        errorMessage = 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø© ÙØ§Ø´Ù„Ø©.';
      msg(errorMessage, 'error');
    } finally {
      loginButton.disabled = false;
      loginButton.innerHTML = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
    }
  };
</script>

</body>
</html>
