<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart HSR | Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ</title>
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg">
  <link rel="stylesheet" href="output.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root { --color-navy:#0A1931; --color-teal:#18A5A2; --color-light-teal:#ACE2E1; --color-gray-bg:#F7F9FC; --color-shadow-base:rgba(10,25,49,.4);}
    body { font-family:'Tajawal',sans-serif; background-color:var(--color-gray-bg); color:var(--color-navy);}
    .kpi-open-gradient{background:linear-gradient(135deg,#EF4444 0%,#B91C1C 100%);color:#fff;box-shadow:0 10px 20px rgba(185,28,28,.4)}
    .kpi-closed-gradient{background:linear-gradient(135deg,#10B981 0%,#18A5A2 100%);color:#fff;box-shadow:0 10px 20px rgba(24,165,162,.4)}
    .kpi-images-gradient{background:linear-gradient(135deg,#3B82F6 0%,#0A1931 100%);color:#fff;box-shadow:0 10px 20px rgba(59,130,246,.4)}
    .kpi-card-professional{transition:.3s; border-radius:1.5rem; position:relative; overflow:hidden; transform:perspective(1px) translateZ(0)}
    .kpi-card-professional::before{content:""; position:absolute; bottom:0; left:0; right:0; height:5px; background-color:rgba(255,255,255,.2); transition:height .3s}
    .kpi-card-professional:hover{transform:translateY(-8px) scale(1.02); z-index:10}
    .kpi-card-professional:hover::before{height:100%; opacity:.1}
    .ai-button-primary{background:var(--color-teal); color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(24,165,162,.5)}
    .ai-button-primary:hover:not(:disabled){background:#148f8c; transform:translateY(-2px); box-shadow:0 8px 20px rgba(24,165,162,.8)}
    .ai-button-secondary{background:var(--color-navy); color:#fff; transition:.3s; box-shadow:0 4px 10px rgba(10,25,49,.6)}
    .ai-button-secondary:hover:not(:disabled){background:#1a3053; transform:translateY(-2px); box-shadow:0 6px 15px rgba(10,25,49,.8)}
    .ai-button-vision{background:#9333ea; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(147,51,234,.5)}
    .ai-button-vision:hover:not(:disabled){background:#7e22ce; transform:translateY(-2px); box-shadow:0 8px 20px rgba(147,51,234,.8)}
    .ai-button-root-cause{background:#881337; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(136,19,55,.5)}
    .ai-button-root-cause:hover:not(:disabled){background:#9f1239; transform:translateY(-2px); box-shadow:0 8px 20px rgba(136,19,55,.8)}
    .ai-button-comm{background:#F97316; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(249,115,22,.5)}
    .ai-button-comm:hover:not(:disabled){background:#ea580c; transform:translateY(-2px); box-shadow:0 8px 20px rgba(249,115,22,.8)}
    .ai-button-grounding{background:#10B981; color:#fff; transition:.3s; box-shadow:0 6px 15px rgba(16,185,129,.5)}
    .ai-button-grounding:hover:not(:disabled){background:#059669; transform:translateY(-2px); box-shadow:0 8px 20px rgba(16,185,129,.8)}
    .loading-spinner{border:4px solid rgba(255,255,255,.3); border-top:4px solid var(--color-light-teal); border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; margin-left:8px}
    .ai-button-primary .loading-spinner,.ai-button-vision .loading-spinner,.ai-button-comm .loading-spinner,.ai-button-grounding .loading-spinner,.ai-button-secondary .loading-spinner,.ai-button-root-cause .loading-spinner{border-top:4px solid #0A1931}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .image-container{position:relative; overflow:hidden; border-radius:.75rem; box-shadow:0 4px 10px var(--color-shadow-base)}
    .image-label{position:absolute; bottom:0; right:0; background:var(--color-navy); color:#fff; padding:.5rem 1rem; font-size:.875rem; font-weight:700; border-top-left-radius:.75rem}
    .observation-item{transition:.2s; border-right:4px solid transparent; cursor:pointer}
    .observation-item:hover{background:#E6F3F3; border-right-color:var(--color-teal)}
    .observation-item.active{background:#E6F3F3; border-right-color:var(--color-navy); box-shadow:0 0 10px rgba(0,0,0,.1)}
    .comparison-wrapper{position:relative; max-width:100%; overflow:hidden; user-select:none; cursor:ew-resize; border-radius:.75rem}
    .comparison-wrapper img,.comparison-wrapper video{display:block; width:100%; height:auto}
    .comparison-wrapper .after-image{position:absolute; top:0; left:0; height:100%; width:50%; overflow:hidden}
    .comparison-wrapper .after-image img,.comparison-wrapper .after-image video{position:absolute; top:0; left:0; width:100%; height:auto}
    .comparison-wrapper .comparison-divider{position:absolute; top:0; left:50%; width:4px; height:100%; background:var(--color-teal); transform:translateX(-50%); cursor:grab; z-index:10; box-shadow:0 0 10px rgba(24,165,162,.8); border-radius:2px; transition:width .1s}
    .comparison-wrapper .comparison-divider:active{cursor:grabbing}
    .comparison-wrapper .comparison-divider-handle{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:40px; height:40px; background:#fff; border:3px solid var(--color-teal); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 15px rgba(0,0,0,.3)}
    .comparison-label{position:absolute; z-index:5; padding:.5rem 1rem; font-size:.875rem; font-weight:700; color:#fff; border-radius:.5rem; opacity:.9; box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .label-before{top:10px; right:10px; background:#B91C1C}
    .label-after{top:10px; left:10px; background:#10B981}
    .communication-draft{white-space:pre-wrap; text-align:right; direction:rtl; font-family:'Tajawal',sans-serif; border-right:4px solid var(--color-teal); padding-right:1rem; line-height:1.8; background:#f8fafc}
    .kpi-insight-container{border-radius:1.5rem; box-shadow:0 10px 30px rgba(0,0,0,.1); border-top:5px solid var(--color-navy)}
    .source-link{color:#0d9488; text-decoration:none; transition:color .2s}
    .source-link:hover{color:var(--color-navy); text-decoration:underline}
    audio{width:100%; margin-top:10px}
    .modal{display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,.6); align-items:center; justify-content:center}
    .modal-content{background:#fefefe; margin:5% auto; padding:30px; border-radius:1.5rem; width:90%; max-width:800px; box-shadow:0 10px 40px rgba(0,0,0,.3); animation:slide-up .3s ease-out; position:relative}
    .input-group-wrapper{display:flex; gap:1rem}
    .input-group{flex-grow:1; text-align:center}
    #loginOverlay{position:fixed; inset:0; background:linear-gradient(135deg, rgba(10,25,49,.96), rgba(24,165,162,.96)); display:flex; align-items:center; justify-content:center; z-index:200}
    #loginCard{background:#fff; border-radius:1.5rem; box-shadow:0 25px 60px rgba(0,0,0,.35); width:95%; max-width:560px; padding:28px}
    .role-pill{padding:.5rem 1rem; border-radius:999px; border:2px solid #e5e7eb; cursor:pointer; user-select:none}
    .role-pill.active{border-color:var(--color-teal); color:#0A1931; background:#E6F3F3; font-weight:800}
    .muted{color:#6b7280; font-size:.875rem}
  </style>
</head>
<body class="text-gray-800">

  <div class="no-print" style="position:sticky; top:0; z-index:50; background:#fff; border-bottom:1px solid #e5e7eb;">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-2 flex items-center justify-between">
      <div class="text-sm font-bold" style="color:var(--color-navy);">Smart HSR â€” Ù†Ø³Ø®Ø© Ù…ØªØµÙ„Ø© (Firebase)</div>
      <div class="flex items-center gap-2">
        <span id="currentUserBadge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold" style="background:#E6F3F3; color:#0A1931;">ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>
        <button id="logout-btn" class="ai-button-secondary rounded-full px-3 py-1 text-xs font-bold flex items-center shadow-lg" onclick="appLogout()" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
          <i data-lucide="log-out" class="w-4 h-4 ml-1"></i> Ø®Ø±ÙˆØ¬
        </button>
        <a href="admin.html" class="ai-button-primary rounded-full px-3 py-1 text-xs font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</a>
      </div>
    </div>
  </div>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <section id="hero" class="text-center py-12 md:py-16 bg-white rounded-3xl shadow-2xl mb-12 border-b-8 border-t-8 border-teal-100 no-print">
      <h1 class="text-5xl md:text-7xl font-extrabold text-gray-900 tracking-tight" style="color:var(--color-navy);">Smart HSR <span style="color:var(--color-teal);">Dashboard</span></h1>
      <h2 class="text-xl md:text-3xl font-extrabold text-gray-600 mt-4">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ</h2>
      <p class="mt-4 text-lg max-w-4xl mx-auto text-gray-500 font-medium">"Ù…Ù†ØµØ© ØªÙ†ÙÙŠØ°ÙŠØ© Ø°ÙƒÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©ØŒ ØªÙˆÙØ± Ø±Ø¤ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡ ÙˆØªØ¯Ø¹Ù… Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."</p>
    </section>

    <section id="observations-log" class="my-20">
      <div class="text-center mb-12 no-print">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ: Ø¯Ù‚Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù†Øµ</h3>
        <p class="mt-3 text-lg text-gray-600">Ø¹Ø±Ø¶ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ù…Ø¹ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¢Ù„ÙŠ.</p>
        <button id="add-observation-btn" class="ai-button-primary rounded-full px-6 py-2 text-md font-bold mt-4 flex items-center justify-center mx-auto" onclick="openModal('smartInputModal')">
          <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ)
        </button>
      </div>

      <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl grid grid-cols-1 lg:grid-cols-3 gap-8 border border-gray-200">
        <div class="lg:col-span-1 border-b lg:border-b-0 lg:border-l border-gray-300 lg:pr-6 pb-6 lg:pb-0 no-print">
          <h4 class="text-2xl font-bold mb-4" style="color:var(--color-teal);">ØªØµÙÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h4>
          <select id="observationFilter" class="w-full p-3 border border-gray-300 rounded-xl text-gray-700 shadow-sm transition-all duration-300" onchange="handleFilterChange()">
            <option value="Ø§Ù„ÙƒÙ„">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</option>
            <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
            <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
            <option value="ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©">ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
            <option value="Ø¬ÙˆØ¯Ø©">Ø¬ÙˆØ¯Ø©</option>
            <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
            <option value="Ø³Ù„Ø§Ù…Ø©">Ø³Ù„Ø§Ù…Ø©</option>
            <option value="Ø¨ÙŠØ¦Ø©">Ø¨ÙŠØ¦Ø©</option>
          </select>

          <h4 class="text-2xl font-bold mt-8 mb-3" style="color:var(--color-navy);">Ø§Ù„Ù…Ù€Ù„Ø§Ø­Ø¸Ù€Ù€Ø§Øª</h4>
          <div id="observationsList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
            <div class="text-center text-gray-500 mt-10">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ...</div>
          </div>
        </div>

        <div class="lg:col-span-2 bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-inner">
          <div class="print-logo hidden mb-6 p-4 border-b border-gray-300">
            <h2 class="text-3xl font-extrabold text-gray-900" style="color:var(--color-navy);">ØªÙ‚Ø±ÙŠØ± Smart HSR Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ</h2>
            <p id="printTitle" class="text-xl font-bold text-teal-600 mt-2"></p>
          </div>

          <h4 class="text-2xl font-extrabold mb-4 border-b-2 border-gray-300 pb-2" style="color:var(--color-teal);">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ (AI Insights)</h4>

          <div id="observationDetail" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-medium mb-6 p-4 bg-white rounded-xl shadow-sm border">
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span><span id="detailTitle" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">Ø§Ù„ØªØµÙ†ÙŠÙ:</span><span id="detailType" class="block font-bold text-teal-600"></span></div>
              <div class="p-2"><span class="block text-gray-500">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span><span id="detailLocation" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù„Ø§Øº:</span><span id="detailDate" class="block font-bold text-gray-800"></span></div>
              <div class="border-b md:border-b-0 md:border-l p-2"><span class="block text-gray-500">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:</span><span id="detailStatus" class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white"></span></div>
              <div class="p-2"><span class="block text-gray-500">Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ù„Ø§Øº:</span><span id="detailID" class="block font-bold text-gray-800"></span></div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-md mb-6 border-l-4 border-teal-500">
              <h5 class="text-xl font-bold mb-3" style="color:var(--color-navy);">ÙˆØµÙ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</h5>
              <p id="detailDescription" class="text-gray-700 leading-relaxed"></p>
              <div id="actionPlanContainer" class="mt-4 p-3 bg-teal-50 rounded-lg hidden">
                <h6 class="font-bold text-teal-700">Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© (HSR Vision AI ğŸ¤–âœ¨)</h6>
                <p id="actionPlan" class="text-sm text-teal-900 mt-1"></p>
              </div>
            </div>

            <div id="resolutionNoteContainer" class="bg-green-50 p-5 rounded-2xl shadow-md mb-6 border-l-4 border-green-500 hidden">
              <h5 class="text-xl font-bold mb-3 text-green-700">ğŸ“ Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ© Ù„Ù„Ø¥ØºÙ„Ø§Ù‚</h5>
              <p id="resolutionNote" class="text-gray-700 leading-relaxed"></p>
            </div>

            <div id="imageComparisonWrapper" class="comparison-wrapper mb-6 hidden">
              <img id="beforeImage" class="before-image w-full h-auto" alt="ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
              <div id="afterImageContainer" class="after-image"><img id="afterImage" class="w-full h-auto" alt="ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="></div>
              <div id="comparisonDivider" class="comparison-divider no-print"><div class="comparison-divider-handle"><i data-lucide="arrow-left-right" class="w-4 h-4 text-teal-600"></i></div></div>
              <span class="comparison-label label-before no-print">Ù‚Ø¨Ù„</span><span class="comparison-label label-after no-print">Ø¨Ø¹Ø¯</span>
            </div>

            <div id="mediaContainer" class="image-container mb-6 hidden"><div id="mediaContent" class="w-full h-auto rounded-xl"></div><span class="image-label">Ù…Ø±ÙÙ‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</span></div>
            <div id="noImageMessage" class="bg-yellow-100 p-4 rounded-xl text-center text-yellow-800 font-medium mb-6 hidden"><i data-lucide="alert-triangle" class="w-5 h-5 inline-block ml-2"></i> Ù„Ø§ ØªØªÙˆÙØ± ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.</div>

            <div id="aiAnalysisSection" class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-gray-200">
              <h5 class="text-xl font-bold mb-4" style="color:var(--color-navy);">Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ <span style="color: var(--color-teal); font-weight:900;">(HSR Vision AI ğŸ¤–âœ¨)</span></h5>
              <div class="flex flex-wrap gap-3 no-print">
                <button class="ai-button-vision rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="runAI('vision')"><i data-lucide="eye" class="w-4 h-4 ml-2"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¨Ø§Ù„Ø±Ø¤ÙŠØ© (Vision)</button>
                <button class="ai-button-root-cause rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="runAI('root')"><i data-lucide="microscope" class="w-4 h-4 ml-2"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ</button>
                <button class="ai-button-comm rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="generateCommunicationDraft()"><i data-lucide="send" class="w-4 h-4 ml-2"></i> ØµÙŠØ§ØºØ© Ø£Ù…Ø± Ø§Ù„Ø¹Ù…Ù„</button>
                <button class="ai-button-grounding rounded-full px-4 py-2 text-sm font-bold flex items-center" onclick="generatePdfReport()"><i data-lucide="file-text" class="w-4 h-4 ml-2"></i> ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± PDF</button>
              </div>
              <div id="aiResultContainer" class="mt-5 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                <h6 id="aiResultTitle" class="font-bold text-lg mb-2" style="color:var(--color-teal);"></h6>
                <div id="aiResultContent" class="text-gray-700"></div>
              </div>
            </div>

            <div id="actionButtons" class="mt-6 pt-4 border-t border-gray-300 flex justify-end gap-3 no-print">
              <button id="updateStatusBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition" onclick="roleGuard('contractor') && markInProgress()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"</button>
              <button id="completeObservationBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition" onclick="roleGuard('contractor') && openModal('closeoutModal')"><i data-lucide="lock" class="w-4 h-4 ml-2"></i> Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ (ØµÙˆØ±Ø© Ø¨Ø¹Ø¯)</button>
              <button id="alreadyCompletedBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition hidden" disabled><i data-lucide="check" class="w-4 h-4 ml-2"></i> Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù…ØºÙ„Ù‚Ø© ÙˆÙ…ÙˆØ«Ù‚Ø©</button>
            </div>
          </div>

          <div id="detailPlaceholder" class="text-center space-y-4">
            <p class="text-gray-500 mt-16 text-lg">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©.</p>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M17 10h.01"/></svg>
          </div>
        </div>
      </div>
    </section>

    <section id="operational-dashboard" class="my-20 no-print">
      <div class="text-center mb-12">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­ÙŠÙˆÙŠØ© (Vital Metrics)</h3>
        <p class="mt-3 text-lg text-gray-600">ØªØªØ¨Ø¹ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø¨Ø§Ù„ØµÙˆØ± Ù„Ø¶Ù…Ø§Ù† ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚.</p>
      </div>
      <div id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
        <div class="p-6 bg-white rounded-2xl shadow-xl border-t-4 border-gray-200"><p class="text-xl font-medium text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p><p class="text-5xl font-extrabold text-gray-700 mt-2">--</p></div>
      </div>
      <div class="mt-12 text-center">
        <button id="kpi-insight-button" class="ai-button-secondary rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto" onclick="generateKpiInsights()"><i data-lucide="bar-chart-3" class="w-5 h-5 ml-2"></i> âœ¨ ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù„ÙˆØ­Ø© (HSR Vision AI ğŸ¤–âœ¨)</button>
        <div id="kpi-insight-result" class="mt-6 text-sm"></div>
      </div>
    </section>

    <section id="ai-features" class="my-20 bg-white p-8 md:p-12 rounded-3xl shadow-2xl border-t-8 border-[--color-teal] no-print">
      <div class="text-center mb-12">
        <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color:var(--color-navy);">ğŸ§  Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙÙŠ ØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
        <p class="mt-3 text-lg text-gray-600">Ø§Ø³ØªÙØ¯ Ù…Ù† Ù†Ù…Ø§Ø°Ø¬ HSR Local Vision AI Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù‚Ø±Ø§Ø±Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°.</p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-7 gap-8 text-center">
        <div class="p-4 rounded-xl border bg-gray-50 hover:shadow-lg transition flex flex-col items-center"><span class="text-4xl mb-2" style="color:#9333ea;">ğŸ‘ï¸</span><h4 class="font-extrabold text-lg mb-1" style="color:var(--color-navy);">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¤ÙŠØ©</h4><p class="text-xs text-gray-600">ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©.</p></div>
        <div class="p-4 rounded-xl border bg-gray-50 hover:shadow-lg transition flex flex-col items-center"><span class="text-4xl mb-2" style="color:var(--color-teal);">âš™ï¸</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">Ø®Ø·Ø© Ø¹Ù…Ù„ Ø¢Ù„ÙŠØ©</h4><p class="text-xs text-gray-600">ØªÙˆÙ„ÙŠØ¯ Ø®Ø·ÙˆØ§Øª ØªÙ†ÙÙŠØ°ÙŠØ© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.</p></div>
        <div class="p-4 rounded-xl border bg-gray-50 hover:shadow-lg transition flex flex-col items-center"><span class="text-4xl mb-2" style="color:var(--color-teal);">ğŸš¨</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h4><p class="text-xs text-gray-600">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© ÙˆØ§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ.</p></div>
        <div class="p-4 rounded-xl border bg-gray-50 hover:shadow-lg transition flex flex-col items-center"><span class="text-4xl mb-2" style="color:#881337;">ğŸ”¬</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ</h4><p class="text-xs text-gray-600">Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¨Ø¨ Ø¬Ø°Ø±ÙŠ ÙˆÙ†ØµÙŠØ­Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ©.</p></div>
        <div class="p-4 rounded-xl border bg-gray-50 hover:shadow-lg transition flex flex-col items-center"><span class="text-4xl mb-2" style="color:#F97316;">âœ‰ï¸</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ØµÙŠØ§ØºØ© Ø§Ù„Ø§ØªØµØ§Ù„</h4><p class="text-xs text-gray-600">ØªÙˆÙ„ÙŠØ¯ Ù…Ø³ÙˆØ¯Ø© Ø£Ù…Ø± Ø¹Ù…Ù„.</p></div>
        <div class="p-4 rounded-xl border bg-gray-50 hover:shadow-lg transition flex flex-col items-center"><span class="text-4xl mb-2" style="color:var(--color-navy);">ğŸ”Š</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">ØªÙ‚Ø±ÙŠØ± ØµÙˆØªÙŠ</h4><p class="text-xs text-gray-600">ØªÙ„Ø®ÙŠØµ ÙˆØªØ­ÙˆÙŠÙ„ Ù„ØµÙˆØª.</p></div>
        <div class="p-4 rounded-xl border bg-gray-50 hover:shadow-lg transition flex flex-col items-center"><span class="text-4xl mb-2" style="color:#10B981;">ğŸŒ</span><h4 class="font-bold text-lg mb-1" style="color:var(--color-navy);">Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</h4><p class="text-xs text-gray-600">Ù…Ø¹Ø§ÙŠÙŠØ± Ø¹Ø§Ù„Ù…ÙŠØ© Ù…Ø³Ø§Ø¹Ø¯Ø©.</p></div>
      </div>
    </section>

    <footer class="text-center mt-20 py-12 border-t-4 border-teal-200 bg-white rounded-t-3xl shadow-2xl no-print">
      <div class="max-w-6xl mx-auto px-4">
        <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="color:var(--color-navy);">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù…Ø¹ Smart HSR</h3>
        <p class="mt-3 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ ÙŠÙØ­ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù† Ø¥Ù„Ù‰ Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ØªÙ†ÙÙŠØ°ÙŠÙ‘Ø©</p>
        <a href="http://wa.me/966507006849" target="_blank" class="mt-8 inline-block" style="background:var(--color-teal);color:#fff;font-weight:800;padding:1rem 3rem;border-radius:999px;">Ø§Ø·Ù„Ø¨ Ø¹Ø±Ø¶Ù‹Ø§ ØªØ¬Ø±ÙŠØ¨ÙŠÙ‹Ø§ Ø§Ù„Ø¢Ù†</a>
        <div class="mt-12 pt-8 border-t border-gray-200">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600 mb-6">
            <div><h4 class="font-bold text-gray-800 mb-2">Ø­ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h4><p>Ù†Ø¸Ø§Ù… Smart HSR Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠ</p></div>
            <div><h4 class="font-bold text-gray-800 mb-2">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</h4><p>Blumark24@gmail.com</p></div>
            <div><h4 class="font-bold text-gray-800 mb-2">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª</h4><p>0507006849</p></div>
          </div>
          <div class="text-xs text-gray-500">
            <p class="mb-2">&copy; 2025 Smart HSR. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
            <p id="userInfo">Ù†Ø³Ø®Ø© Ù…ØªØµÙ„Ø© â€” Firebase</p>
          </div>
        </div>
      </div>
    </footer>
  </main>

  <!-- Modals: Smart Input & Closeout -->
  <div id="smartInputModal" class="modal no-print">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('smartInputModal')">&times;</span>
      <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b" style="color:var(--color-navy);">ÙˆØ­Ø¯Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Smart HSR)</h2>
      <div id="modalStep1">
        <p class="text-lg text-gray-600 mb-4">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø£Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ù„Ù†ØµØŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„ØµÙˆØ±Ø©)</p>
        <textarea id="rawObservationInput" rows="5" class="w-full p-4 border border-gray-300 rounded-xl" placeholder="Ù…Ø«Ø§Ù„: ÙŠÙˆØ¬Ø¯ ØªØ¬Ù…Ø¹ Ù„Ù„Ù…ÙŠØ§Ù‡ Ø¹Ù„Ù‰ Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø®Ø¯Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙƒÙŠÙ„Ùˆ 52..." oninput="checkSmartInputState()"></textarea>
        <div class="input-group-wrapper">
          <div class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white">
            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (GPS):</label>
            <p id="locationStatus" class="text-sm font-semibold text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯</p>
            <input type="hidden" id="inputLatitude"><input type="hidden" id="inputLongitude">
            <button id="getLocationBtn" class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2" onclick="getLocation()" type="button"><i data-lucide="map-pin" class="w-4 h-4 ml-2"></i> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
          </div>
          <div class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white">
            <label class="block text-sm font-medium text-gray-700 mb-2">Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:</label>
            <p id="fileStatus" class="text-sm font-semibold text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯</p>
            <input type="file" id="fileUploadInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
            <button class="ai-button-secondary rounded-full px-4 py-2 text-sm font-bold mt-2" onclick="document.getElementById('fileUploadInput').click()" type="button"><i data-lucide="upload" class="w-4 h-4 ml-2"></i> Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</button>
          </div>
        </div>
        <div class="mt-6 text-center">
          <button id="processSmartInputBtn" class="ai-button-vision rounded-full px-8 py-3 text-lg font-bold" onclick="processSmartInput()" disabled><i data-lucide="cpu" class="w-5 h-5 ml-2"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </div>
      <div id="modalResult" class="mt-8 pt-6 border-t border-gray-200 hidden">
        <h3 class="text-2xl font-bold mb-4" style="color:var(--color-teal);">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <div id="modalResultContent"></div>
        <div class="mt-6 text-center"><button class="ai-button-primary rounded-full px-6 py-2 text-md font-bold" onclick="closeModal('smartInputModal')">Ø¥ØºÙ„Ø§Ù‚ ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯</button></div>
      </div>
    </div>
  </div>

  <div id="closeoutModal" class="modal no-print">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('closeoutModal'); clearAfterUpload();">&times;</span>
      <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b text-green-700">ğŸ”’ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø© #<span id="closeoutId"></span></h2>
      <p class="text-lg text-gray-600 mb-4">Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŒ ÙŠØ¬Ø¨ ØªÙˆØ«ÙŠÙ‚ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¨Ù€ <b>ØµÙˆØ±Ø© "Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­"</b> ÙˆÙ…Ø°ÙƒØ±Ø© Ø®ØªØ§Ù…ÙŠØ©.</p>
      <div class="p-6 bg-gray-50 rounded-xl border border-gray-200">
        <h3 class="text-xl font-bold mb-3" style="color:var(--color-navy);">1. ØªÙˆØ«ÙŠÙ‚ ØµÙˆØ±Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (After Photo)</h3>
        <div class="input-group p-4 border-2 border-dashed border-red-300 rounded-xl bg-white">
          <label class="block text-sm font-medium text-gray-700 mb-2">Ø±ÙØ¹ ØµÙˆØ±Ø© <b>Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­/Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</b> (<span class="text-red-500 font-bold">Ø¥Ù„Ø²Ø§Ù…ÙŠ</span>):</label>
          <p id="afterFileStatus" class="text-sm font-semibold text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯</p>
          <input type="file" id="afterFileUploadInput" accept="image/*" class="hidden" onchange="handleAfterFileUpload(event)">
          <button class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2" onclick="document.getElementById('afterFileUploadInput').click()" type="button"><i data-lucide="camera" class="w-4 h-4 ml-2"></i> Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <h3 class="text-xl font-bold mt-6 mb-3" style="color:var(--color-navy);">2. Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ©</h3>
        <textarea id="resolutionNoteInput" rows="4" class="w-full p-3 border rounded-xl" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ©..."></textarea>
      </div>
      <div class="mt-6 text-center">
        <button id="finalCloseoutBtn" class="bg-green-600 hover:bg-green-700 rounded-full px-8 py-3 text-lg font-bold" onclick="roleGuard('contractor') && completeObservation()" disabled><i data-lucide="check-square" class="w-5 h-5 ml-2"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
      </div>
    </div>
  </div>

  <div id="loginOverlay">
    <div id="loginCard">
      <h2 class="text-3xl font-extrabold mb-2" style="color:var(--color-navy);">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <p class="muted mb-4">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±. (Ù…Ù† Ø¯Ø¹ÙˆØ© Ø§Ù„Ù…Ø¯ÙŠØ±)</p>
      <div class="grid grid-cols-1 gap-3">
        <div><label class="block text-sm font-bold mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input id="login-username" class="w-full p-3 border rounded-xl" placeholder="email@example.com"/></div>
        <div><label class="block text-sm font-bold mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="login-password" type="password" class="w-full p-3 border rounded-xl" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
        <button class="ai-button-secondary rounded-full px-6 py-3 text-md font-bold" onclick="doLogin()"><i data-lucide="log-in" class="w-5 h-5 ml-2"></i> Ø¯Ø®ÙˆÙ„</button>
        <div class="muted">Ù„Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ù‹Ø§.</div>
      </div>
    </div>
  </div>

  <script>
    // --- Helpers / UI ---
    function setText(id, text){ const el=document.getElementById(id); if(el) el.textContent = text ?? ''; }
    function setHTML(id, html){ const el=document.getElementById(id); if(el) el.innerHTML = html ?? ''; }
    function hide(id){ const el=document.getElementById(id); if(el) el.classList.add('hidden'); }
    function unhide(id){ const el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
    function toggleHidden(id, cond){ const el=document.getElementById(id); if(el) cond?el.classList.add('hidden'):el.classList.remove('hidden'); }
    function loaderHTML(msg){ return `<div class="text-center py-10"><div class="loading-spinner" style="border-top-color: var(--color-teal); margin:0 auto; width:40px; height:40px;"></div><p class="mt-4 text-xl font-extrabold text-teal-700">${msg}</p></div>`; }
    function successHTML(msg){ return `<div class="p-6 bg-green-50 rounded-xl border-4 border-green-200 text-center"><i data-lucide="check-circle" class="w-10 h-10 mx-auto text-green-600 mb-3"></i><h4 class="text-2xl font-extrabold text-green-700">${msg}</h4></div>`; }
    function errorHTML(msg){ return `<div class="p-6 bg-red-50 rounded-xl border-4 border-red-200 text-center"><i data-lucide="x-circle" class="w-10 h-10 mx-auto text-red-600 mb-3"></i><h4 class="text-2xl font-extrabold text-red-700">${msg}</h4></div>`; }
    function escapeHTML(str){ return (str||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function cryptoRandom(){ return (crypto.getRandomValues(new Uint32Array(2)).join('')); }

    // Files
    let currentFile=null, currentAfterFile=null;
    function checkSmartInputState(){
      const text = document.getElementById('rawObservationInput').value.trim();
      document.getElementById('processSmartInputBtn').disabled = !(text.length>0 || currentFile || document.getElementById('inputLatitude').value);
    }
    function handleFileUpload(e){
      const file = e.target.files[0];
      if(!file){ currentFile=null; setText('fileStatus','Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯'); checkSmartInputState(); return; }
      if(!file.type.startsWith('image/')){ alert('ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØ± ÙÙ‚Ø·'); e.target.value=''; return; }
      currentFile=file; setText('fileStatus', `ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${file.name}`); checkSmartInputState();
    }
    function handleAfterFileUpload(e){
      const file = e.target.files[0];
      if(!file){ currentAfterFile=null; setHTML('afterFileStatus','Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯ <span class="text-red-500 font-bold">(Ø¥Ù„Ø²Ø§Ù…ÙŠ)</span>'); document.getElementById('finalCloseoutBtn').disabled=true; return; }
      if(!file.type.startsWith('image/')){ alert('ÙŠØ¬Ø¨ ØµÙˆØ±Ø©'); e.target.value=''; return; }
      currentAfterFile=file; setHTML('afterFileStatus', `<span class="text-green-600">ØªÙ… Ø§Ø®ØªÙŠØ§Ø±:</span> ${file.name}`); document.getElementById('finalCloseoutBtn').disabled=false;
    }
    function fileToBase64(file){
      return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file); });
    }

    // GPS
    async function getLocation(){
      const statusEl = document.getElementById("locationStatus");
      if (!navigator.geolocation) { statusEl.innerText="Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS."; return; }
      statusEl.innerHTML = "ğŸ“¡ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude.toFixed(6), lon = pos.coords.longitude.toFixed(6);
          document.getElementById("inputLatitude").value = lat;
          document.getElementById("inputLongitude").value = lon;
          const link = `https://www.google.com/maps?q=${lat},${lon}`;
          statusEl.innerHTML = `âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯: ${lat}, ${lon} <br><a href="${link}" target="_blank" class="source-link">ÙØªØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ğŸ“</a>`;
          checkSmartInputState();
        },
        err => { statusEl.innerText = (err.code===1) ? "âš ï¸ Ø§Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹." : "âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹."; },
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
      );
    }

    // Local AI (vision/root/repair) â€“ same behavior, offline.
    function keywordsAR(s=''){ s=(s||'').toLowerCase(); const k=[]; const add=v=>{if(!k.includes(v))k.push(v)};
      if(/Ø´Ù‚|ØªØµØ¯Ø¹|ØªØ´Ù‚Ù‚Ø§Øª|ÙƒØ³Ø±/.test(s)) add('crack');
      if(/Ù‡Ø¨ÙˆØ·|Ø­ÙØ±|Ø­ÙØ±Ø©/.test(s)) add('pothole');
      if(/Ù…ÙŠØ§Ù‡|ØªØ¬Ù…Ø¹|Ø³ÙŠÙˆÙ„|ØµØ±Ù/.test(s)) add('water');
      if(/Ù„ÙˆØ­Ø©|Ø¥Ø±Ø´Ø§Ø¯|Ø¹Ù„Ø§Ù…Ø©|Ø¯Ù‡Ø§Ù†/.test(s)) add('sign');
      if(/ØµØ¯Ø£|ØªØ¢ÙƒÙ„/.test(s)) add('corrosion');
      if(/Ø³Ù„Ø§Ù…Ø©|ppe|Ø®ÙˆØ°|Ø­Ù…Ø§ÙŠØ©/.test(s)) add('safety');
      if(/ØªÙ…Ø¯ÙŠØ¯|ÙƒÙ‡Ø±Ø¨|ÙƒØ§Ø¨Ù„|Ù…Ø§Ø³ÙˆØ±Ø©|ØªØµØ±ÙŠÙ/.test(s)) add('utility'); return k; }
    function visionDescription(o){ const t=`${o?.title||''} ${o?.details||''}`, k=keywordsAR(t);
      if(k.includes('crack')) return 'ØªØ´Ù‚Ù‚Ø§Øª Ø³Ø·Ø­ÙŠØ© Ø¥Ù„Ù‰ Ù…ØªÙˆØ³Ø·Ø©...';
      if(k.includes('pothole')) return 'Ø­ÙØ±Ø©/Ù‡Ø¨ÙˆØ· Ù…ÙˆØ¶Ø¹ÙŠ ÙˆØ§Ø¶Ø­...';
      if(k.includes('water')) return 'ØªØ¬Ù…Ø¹ Ù…ÙŠØ§Ù‡ Ø³Ø·Ø­ÙŠ ÙŠØ´ÙŠØ± Ù„Ù‚ØµÙˆØ± Ø§Ù„ØªØµØ±ÙŠÙ...';
      if(k.includes('sign')) return 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠ/Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª...';
      if(k.includes('corrosion')) return 'Ø¨ÙˆØ§Ø¯Ø± ØªØ¢ÙƒÙ„/ØµØ¯Ø£ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¹Ø¯Ù†ÙŠ...';
      if(k.includes('safety')) return 'Ù…Ø®Ø§Ù„ÙØ© Ø§Ø´ØªØ±Ø§Ø·Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©...';
      if(k.includes('utility')) return 'Ø§Ø­ØªÙ…Ø§Ù„ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø®Ø¯Ù…Ø§Øª...';
      return 'Ù…Ø¤Ø´Ø±Ø§Øª Ø®Ù„Ù„ Ù…ÙˆØ¶Ø¹ÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙØ§Ù‚Ù… Ø¥Ù† Ù„Ù… ØªÙØ¹Ø§Ù„Ø¬.'; }
    function rootCause(o){ const t=`${o?.title||''} ${o?.details||''}`, k=keywordsAR(t);
      if(k.includes('water')) return 'Ù‚ØµÙˆØ± ØªØµØ±ÙŠÙ/Ø§Ù†Ø³Ø¯Ø§Ø¯ Ù…ØµØ§Ø±Ù...';
      if(k.includes('crack')) return 'ØªØ¹Ø¨ Ù…Ø±ÙˆØ±ÙŠ/Ø´ÙŠØ®ÙˆØ®Ø© Ø±Ø§Ø¨Ø·Ø©...';
      if(k.includes('pothole')) return 'Ø§Ù†Ù‡ÙŠØ§Ø± Ù…ÙˆØ¶Ø¹ÙŠ Ù„Ù„Ø·Ø¨Ù‚Ø§Øª Ù†ØªÙŠØ¬Ø© Ø±Ø·ÙˆØ¨Ø©/Ø£Ø­Ù…Ø§Ù„...';
      if(k.includes('sign')) return 'ØªØ¹Ø±Ø¶ Ø·ÙˆÙŠÙ„ Ù„Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø¬ÙˆÙŠØ©...';
      if(k.includes('corrosion')) return 'ØªØ¹Ø±Ø¶ Ù…Ø³ØªÙ…Ø± Ù„Ù„Ø±Ø·ÙˆØ¨Ø©/Ø§Ù„Ø£Ù…Ù„Ø§Ø­...';
      if(k.includes('safety')) return 'Ø¶Ø¹Ù Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©...';
      return 'ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù…Ø¹ Ø¹ÙˆØ§Ù…Ù„ Ø¨ÙŠØ¦ÙŠØ©/Ù…Ø±ÙˆØ±ÙŠØ©.'; }
    function repairRecommendation(o){ const t=`${o?.title||''} ${o?.details||''}`, k=keywordsAR(t);
      if(k.includes('pothole')) return 'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…ÙÙƒÙƒØ©ØŒ Ù‚ØµÙ‘ Ù…Ù†ØªØ¸Ù…ØŒ Tack CoatØŒ Ø±Ø¯Ù… Ø¨Ø·Ø¨Ù‚ØªÙŠÙ† ÙˆØ¯ÙƒÙ‘ Ø·Ø¨Ù‚ÙŠ.';
      if(k.includes('crack')) return 'ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ù‚ÙˆÙ‚ ÙˆÙ…Ù„Ø¤Ù‡Ø§ Ø¨Ø³ÙŠÙ„Ø§Ù†ØªØŒ ÙˆÙ…Ø¹ Ø§Ù„Ø´Ø¨ÙƒÙŠ Ù‚ØµÙ‘ ÙˆØ±ØµÙ Ù…ÙˆØ¶Ø¹ÙŠ.';
      if(k.includes('water')) return 'ÙØªØ­ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØµØ§Ø±ÙØŒ ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ÙŠÙˆÙ„ØŒ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙ„Ù.';
      if(k.includes('sign')) return 'Ø§Ø³ØªØ¨Ø¯Ø§Ù„/Ø¥Ø¹Ø§Ø¯Ø© Ø¯Ù‡Ø§Ù† Ø¨Ù…ÙˆØ§Ø¯ Ø¹Ø§ÙƒØ³Ø© Ù…Ø·Ø§Ø¨Ù‚Ø©.';
      if(k.includes('corrosion')) return 'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµØ¯Ø£ ÙˆØ¯Ù‡Ø§Ù† ÙˆØ§Ù‚Ù ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¶Ø¹ÙŠÙ.';
      if(k.includes('safety')) return 'ÙØ±Ø¶ Ø§Ù„ØªØ²Ø§Ù… PPE ÙˆØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØªÙØªÙŠØ´ Ø¯ÙˆØ±ÙŠ.';
      return 'Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ÙˆØ¶Ø¹ÙŠØ©: Ù‚ØµÙ‘ ÙˆØªÙ†Ø¸ÙŠÙ ÙˆØ·Ø¨Ù‚Ø© Ø±Ø§Ø¨Ø·Ø© ÙˆØ±Ù‚Ø¹Ø© Ø¥Ø³ÙÙ„ØªÙŠØ©.'; }
    function runLocalVisionAI(obs){ return { vision:visionDescription(obs), root:rootCause(obs), repair:repairRecommendation(obs) }; }
    function renderAIResults(obs){
      const r=runLocalVisionAI(obs||{});
      const wrap=document.getElementById('aiResultContainer');
      document.getElementById('aiResultTitle').textContent='Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„ â€” HSR Vision AI (Ù…Ø­Ù„ÙŠ)';
      document.getElementById('aiResultContent').innerHTML=`<div class="communication-draft"><p><b>ğŸ” Vision:</b><br>${r.vision}</p><p class="mt-3"><b>ğŸ§ª Root:</b><br>${r.root}</p><p class="mt-3"><b>ğŸ› ï¸ Repair:</b><br>${r.repair}</p></div><p class="text-xs text-gray-500 mt-4 italic border-t pt-2">ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ø­Ù„ÙŠÙ‹Ø§ â€” Ø¨Ù„Ø§ Ù…ÙØ§ØªÙŠØ­.</p>`;
      wrap.classList.remove('hidden');
    }
    window.runAI = mode => { setText('aiResultTitle', (mode==='vision'?'ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ± (Vision)':'Ø§Ù„ØªØ­Ù„ÙŠÙ„')); setHTML('aiResultContent', `<div class='flex items-center text-teal-700 font-bold'><div class='loading-spinner' style='border-top-color: var(--color-teal); margin-left:8px;'></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</div>`); unhide('aiResultContainer'); setTimeout(()=>renderAIResults(window.currentSelectedObservation||{}), 700); };

    function openModal(id){ document.getElementById(id).style.display = "flex"; if(id==='smartInputModal'){ document.getElementById('rawObservationInput').value=''; setText('locationStatus','Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯'); setText('fileStatus','Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯'); document.getElementById('inputLatitude').value=''; document.getElementById('inputLongitude').value=''; currentFile=null; document.getElementById('fileUploadInput').value=''; document.getElementById('processSmartInputBtn').disabled=true; } if(id==='closeoutModal' && window.currentSelectedObservation){ document.getElementById('closeoutId').textContent = window.currentSelectedObservation.id || '-'; } }
    function closeModal(id){ document.getElementById(id).style.display = "none"; }
    window.openModal=openModal; window.closeModal=closeModal;

    function setupImageComparison(){
      const wrapper=document.getElementById('imageComparisonWrapper'), divider=document.getElementById('comparisonDivider'), after=document.getElementById('afterImageContainer'); if(!wrapper) return;
      after.style.width='50%'; divider.style.left='50%'; let drag=false;
      const move=(x)=>{ if(!drag) return; const r=wrapper.getBoundingClientRect(); let left=Math.max(0,Math.min(x-r.left,r.width)); divider.style.left=`${left}px`; after.style.width=`${left}px`; };
      const up=()=>{ drag=false; window.removeEventListener('mousemove',onMouse); window.removeEventListener('touchmove',onTouch); window.removeEventListener('mouseup',up); window.removeEventListener('touchend',up); };
      const onMouse=e=>move(e.clientX); const onTouch=e=>move(e.touches[0].clientX);
      const down=e=>{ e.preventDefault(); drag=true; move((e.touches?e.touches[0].clientX:e.clientX)); window.addEventListener('mousemove',onMouse); window.addEventListener('touchmove',onTouch); window.addEventListener('mouseup',up); window.addEventListener('touchend',up); };
      divider.addEventListener('mousedown',down); divider.addEventListener('touchstart',down); wrapper.addEventListener('mousedown',down); wrapper.addEventListener('touchstart',down);
    }
    window.handleFilterChange = function(){ const v=document.getElementById('observationFilter').value; let filtered=window.observationsData||[]; if(v!=='Ø§Ù„ÙƒÙ„'){ const map={"Ø¬Ø¯ÙŠØ¯":"PENDING","Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°":"IN_PROGRESS","ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©":"COMPLETED","Ø¬ÙˆØ¯Ø©":"QUALITY","ØµÙŠØ§Ù†Ø©":"MAINTENANCE","Ø³Ù„Ø§Ù…Ø©":"SAFETY","Ø¨ÙŠØ¦Ø©":"ENVIRONMENT"}; const key=map[v]||v; filtered=filtered.filter(o=>o.type===key || o.status===key);} renderObservationsList(filtered); if(filtered.length>0) showObservationDetail(filtered[0].docId); else { unhide('detailPlaceholder'); hide('observationDetail'); } };
    window.renderKPIs = function(){ const total=(window.observationsData||[]).length; const open=(window.observationsData||[]).filter(o=>o.status!=='COMPLETED').length; const closed=total-open; const withImg=(window.observationsData||[]).filter(o=>!!o.imagePath).length; const k=document.getElementById('kpiContainer'); k.innerHTML=''; const data=[{title:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª',value:total,icon:'clipboard-list',gradientClass:'kpi-closed-gradient'},{title:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙØªÙˆØ­Ø©/Ø§Ù†ØªØ¸Ø§Ø±',value:open,icon:'alert-triangle',gradientClass:'kpi-open-gradient'},{title:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ØºÙ„Ù‚Ø©/Ù…Ø¹Ø§Ù„Ø¬Ø©',value:closed,icon:'check-circle',gradientClass:'kpi-closed-gradient'},{title:'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙˆØ«Ù‚Ø© Ø¨Ø§Ù„ØµÙˆØ±',value:withImg,icon:'image',gradientClass:'kpi-images-gradient'}]; data.forEach(kpi=>{ k.innerHTML+=`<div class="kpi-card-professional p-6 ${kpi.gradientClass} flex items-center justify-between shadow-2xl"><div><p class="text-sm md:text-md font-medium">${kpi.title}</p><p class="text-4xl md:text-5xl font-extrabold mt-1">${kpi.value}</p></div><i data-lucide="${kpi.icon}" class="w-10 h-10 opacity-70"></i></div>`;}); lucide.createIcons(); };
    function setTextContent(el, text){ if(el) el.textContent=text; }

    window.renderObservationsList = function(obs){ const list=document.getElementById('observationsList'); list.innerHTML=''; if(!obs || obs.length===0){ list.innerHTML='<div class="text-center text-gray-500 mt-10 p-4 bg-gray-100 rounded-xl">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª.</div>'; document.getElementById('detailPlaceholder').classList.remove('hidden'); document.getElementById('observationDetail').classList.add('hidden'); return; } obs.forEach(o=>{ const st=(o.status||'').toUpperCase(); const color= st==='COMPLETED'?'bg-green-600':(st==='IN_PROGRESS'?'bg-yellow-600':'bg-red-600'); const isSel=(window.currentSelectedObservation && o.docId===window.currentSelectedObservation.docId)?'active':''; list.innerHTML+=`<div class="observation-item p-3 rounded-lg flex justify-between items-center ${isSel}" onclick="showObservationDetail('${o.docId}')"><div><p class="text-md font-bold text-gray-800 truncate max-w-[200px]">${escapeHTML(o.title||'')}</p><p class="text-xs text-gray-500 mt-1">${o.date||''} | ${escapeHTML(o.type||'')}</p></div><span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${color} text-white">${st}</span></div>`; }); };

    window.showObservationDetail = function(docId){ const obs=(window.observationsData||[]).find(o=>o.docId===docId); if(!obs) return; window.currentSelectedObservation=obs; document.querySelectorAll('.observation-item').forEach(i=>i.classList.remove('active')); const lis=Array.from(document.querySelectorAll('.observation-item')); const li=lis.find(el=>el.getAttribute('onclick')===`showObservationDetail('${docId}')`); if(li) li.classList.add('active'); const st=(obs.status||'').toUpperCase(); const color= st==='COMPLETED'?'bg-green-600':(st==='IN_PROGRESS'?'bg-yellow-600':'bg-red-600'); setText('detailTitle', obs.title); setText('printTitle', `Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: ${obs.title}`); setText('detailType', obs.type); setText('detailDate', obs.date); setText('detailID', obs.id || '-'); setText('detailLocation', obs.location || '-'); const ds=document.getElementById('detailStatus'); ds.textContent=st; ds.className=`inline-block px-3 py-1 text-sm font-semibold rounded-full text-white ${color}`; document.getElementById('detailDescription').innerHTML=(obs.details||'').replace(/\n/g,'<br>'); setText('actionPlan', `Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${obs.riskAssessment?.priority||'-'} | Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ: ${obs.riskAssessment?.timeframe||'-'}. Ø§Ù„Ø®Ø·Ø©: ${obs.actionPlan||'-'}`); document.getElementById('actionPlanContainer').classList.remove('hidden'); hide('mediaContainer'); hide('imageComparisonWrapper'); hide('noImageMessage'); hide('resolutionNoteContainer'); const mediaContent=document.getElementById('mediaContent'); mediaContent.innerHTML=''; if(st==='COMPLETED' && obs.afterImagePath){ unhide('imageComparisonWrapper'); document.getElementById('beforeImage').src = obs.imagePath || ''; document.getElementById('afterImage').src  = obs.afterImagePath || ''; setupImageComparison(); setText('resolutionNote', obs.resolutionNote || 'Ù„Ù… ÙŠØªÙ… ØªÙˆÙÙŠØ± Ù…Ø°ÙƒØ±Ø© Ø¥ØºÙ„Ø§Ù‚.'); unhide('resolutionNoteContainer'); } else if (obs.imagePath){ unhide('mediaContainer'); mediaContent.innerHTML = `<img class="w-full h-auto rounded-xl shadow-lg" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©" src="${obs.imagePath}">`; } else { unhide('noImageMessage'); } const isCompleted=(st==='COMPLETED'); toggleHidden('updateStatusBtn', isCompleted); toggleHidden('completeObservationBtn', isCompleted); toggleHidden('alreadyCompletedBtn', !isCompleted); hide('detailPlaceholder'); unhide('observationDetail'); hide('aiResultContainer'); lucide.createIcons(); };

    // guard
    window.roleGuard = function(required){ if(!window.CURRENT_USER){ alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); return false; } if(window.CURRENT_USER.role !== required){ alert('ğŸš« Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.'); return false; } return true; };
  </script>

  <!-- Firebase binding (real) -->
  <script type="module">
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    window.doLogin = async function () {
      const email = document.getElementById('login-username').value.trim();
      const pass  = document.getElementById('login-password').value.trim();
      try { await signInWithEmailAndPassword(auth, email, pass); }
      catch (e) { alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); console.error(e); }
    };
    window.appLogout = ()=> signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        document.getElementById('loginOverlay').style.display='flex';
        document.getElementById('currentUserBadge').textContent='ØºÙŠØ± Ù…Ø³Ø¬Ù„';
        return;
      }
      document.getElementById('loginOverlay').style.display='none';
      document.getElementById('currentUserBadge').textContent = user.email;

      const uDoc = await getDoc(doc(db,'users', user.uid));
      const userRole = uDoc.exists() ? (uDoc.data().role||'') : '';
      window.CURRENT_USER = { role:userRole, username:user.email, name:uDoc.data()?.name||user.email };

      const q = query(collection(db,'observations'), orderBy('createdAt','desc'));
      onSnapshot(q, (snap)=>{
        window.observationsData = [];
        let idx=1;
        snap.forEach(d => window.observationsData.push({ docId:d.id, id: (d.data().id||idx++), ...d.data() }));
        renderKPIs();
        renderObservationsList(window.observationsData);
        if (window.observationsData.length>0) showObservationDetail(window.observationsData[0].docId);
        lucide.createIcons();
      });
    });

    async function uploadBase64(dataUrl, path){
      const rf = sRef(storage, path);
      await uploadString(rf, dataUrl, 'data_url');
      return await getDownloadURL(rf);
    }

    window.processSmartInput = async function(){
      if(!window.CURRENT_USER){ alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); return; }
      if(window.CURRENT_USER.role!=='inspector'){ alert('ğŸš« Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª.'); return; }

      const rawText = document.getElementById('rawObservationInput').value.trim();
      const lat = document.getElementById('inputLatitude').value || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      const lon = document.getElementById('inputLongitude').value || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      if (!rawText && !currentFile) { alert('Ø£Ø¯Ø®Ù„ ÙˆØµÙØ§Ù‹ Ø£Ùˆ ØµÙˆØ±Ø©.'); return; }

      hide('modalStep1'); unhide('modalResult');
      setHTML('modalResultContent', loaderHTML('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...'));

      try{
        let imageUrl = null;
        if (currentFile) {
          const base64 = await fileToBase64(currentFile);
          imageUrl = await uploadBase64(base64, `before/${Date.now()}-${currentFile.name}`);
        }
        const localAnalysis = (function(txt){ return { actionPlan:'Ø±Ù‚Ø¹Ø© Ø¥Ø³ÙÙ„ØªÙŠØ© ÙˆØ¥Ø²Ø§Ù„Ø© Ø£Ø«Ø± Ø§Ù„Ù…ÙŠØ§Ù‡', risk:{priority:'Medium', timeframe:'72 hours'} }; })(rawText);
        const newDate = new Date().toISOString().slice(0,10);

        await addDoc(collection(db,'observations'), {
          type: "MAINTENANCE", date: newDate,
          title: rawText ? (rawText.substring(0,50) + (rawText.length>50?'...':'')) : 'Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø¯ÙˆÙ† Ù†Øµ',
          status: "PENDING",
          details: `**ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¢Ù„ÙŠØ§Ù‹.**\nØ§Ù„ÙˆØµÙ Ø§Ù„Ø£ÙˆÙ„ÙŠ: "${rawText || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}"\nØ§Ù„Ù…ÙˆÙ‚Ø¹: (${lat}, ${lon})`,
          imagePath: imageUrl, isComparative: false,
          location: (lat && lon) ? `${lat}, ${lon}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          actionPlan: localAnalysis.actionPlan,
          riskAssessment: localAnalysis.risk,
          resolutionNote: null, afterImagePath: null,
          createdAt: serverTimestamp(), createdBy: (auth.currentUser?auth.currentUser.uid:null)
        });

        setHTML('modalResultContent', successHTML('ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­.'));
        currentFile=null; document.getElementById('fileUploadInput').value=''; document.getElementById('rawObservationInput').value='';
        setText('fileStatus','Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø¹Ø¯'); setText('locationStatus','Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯');
        document.getElementById('inputLatitude').value=''; document.getElementById('inputLongitude').value=''; document.getElementById('processSmartInputBtn').disabled=true;
      }catch(e){
        console.error(e); setHTML('modalResultContent', errorHTML('ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.'));
      }finally{ lucide.createIcons(); }
    };

    window.completeObservation = async function(){
      if (!window.currentSelectedObservation) return;
      if(window.CURRENT_USER.role!=='contractor'){ alert('ğŸš« Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚.'); return; }
      if (!currentAfterFile) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ ØµÙˆØ±Ø© "Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­".'); return; }

      try{
        const afterBase64 = await fileToBase64(currentAfterFile);
        const afterUrl = await uploadBase64(afterBase64, `after/${Date.now()}-${currentAfterFile.name}`);
        const note = (document.getElementById('resolutionNoteInput').value||'').trim() || `ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ ÙÙŠ ${new Date().toLocaleString('ar-SA')}.`;
        await updateDoc(doc(db,'observations', window.currentSelectedObservation.docId), {
          status: 'COMPLETED', isComparative: true, afterImagePath: afterUrl, resolutionNote: note
        });
        closeModal('closeoutModal'); document.getElementById('afterFileUploadInput').value=''; currentAfterFile=null; alert('ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙˆØªÙˆØ«ÙŠÙ‚Ù‡ Ø¨Ù†Ø¬Ø§Ø­!');
      }catch(e){ console.error(e); alert('ØªØ¹Ø°Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚.'); }
    };
  </script>
  <script> lucide.createIcons(); </script>
</body>
</html>