<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart HSR | ููุญุฉ ุงูููุงุฏุฉ ุงูุชูููุฐูุฉ - ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</title>

    <meta name="description"
        content="ูุธุงู Smart HSR ูููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู - ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
    <meta name="keywords"
        content="Smart HSR, ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ, ูุธุงู ุงููุฑุงูุจุฉ, ููุญุฉ ุชุญูู, ุงูุฐูุงุก ุงูุงุตุทูุงุนู, ุชุญููู ุงูุจูุงูุงุช">
    <meta name="author" content="Smart HSR">
    <meta name="robots" content="index, follow">

    <meta property="og:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
    <meta property="og:description"
        content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_SA">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
    <meta name="twitter:description" content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ">

    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.svg">

    <link rel="stylesheet" href="output.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Professional & Executive Palette */
            --color-navy: #0A1931;
            /* Primary Dark Color */
            --color-teal: #18A5A2;
            /* Accent/Highlight Color */
            --color-light-teal: #ACE2E1;
            /* Light Accent */
            --color-gray-bg: #F7F9FC;
            /* Clean Background */
            --color-shadow-base: rgba(10, 25, 49, 0.4);
            /* Deep Navy Shadow */
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--color-gray-bg);
            color: var(--color-navy);
        }

        /* Gradient for Open Reports (Urgency - Red/Orange) */
        .kpi-open-gradient {
            background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%);
            /* Red to Deep Red */
            color: white;
            box-shadow: 0 10px 20px rgba(185, 28, 28, 0.4);
        }

        /* Gradient for Closed Reports (Success - Teal/Green) */
        .kpi-closed-gradient {
            background: linear-gradient(135deg, #10B981 0%, #18A5A2 100%);
            /* Green to Teal */
            color: white;
            box-shadow: 0 10px 20px rgba(24, 165, 162, 0.4);
        }

        /* Gradient for Total Images (Information - Blue/Navy) */
        .kpi-images-gradient {
            background: linear-gradient(135deg, #3B82F6 0%, #0A1931 100%);
            /* Blue to Navy */
            color: white;
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }

        /* Gradient for Missing Images (Warning - Yellow/Orange) */
        .kpi-missing-gradient {
            background: linear-gradient(135deg, #FCD34D 0%, #F97316 100%);
            /* Yellow to Orange */
            color: var(--color-navy);
            /* Dark text for contrast on light gradient */
            box-shadow: 0 10px 20px rgba(253, 211, 77, 0.4);
        }

        /* Common KPI Card Styles */
        .kpi-card-professional {
            transition: all 0.3s ease;
            border-radius: 1.5rem;
            /* Rounded corners */
            position: relative;
            overflow: hidden;
            transform: perspective(1px) translateZ(0);
            /* For hardware acceleration */
        }

        .kpi-card-professional::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            transition: height 0.3s ease;
        }

        .kpi-card-professional:hover {
            transform: translateY(-8px) scale(1.02);
            z-index: 10;
        }

        .kpi-card-professional:hover::before {
            height: 100%;
            opacity: 0.1;
        }

        /* General UI Elements */
        .ai-button-primary {
            background-color: var(--color-teal);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(24, 165, 162, 0.5);
        }

        .ai-button-primary:hover:not(:disabled) {
            background-color: #148f8c;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(24, 165, 162, 0.8);
        }

        .ai-button-secondary {
            background-color: var(--color-navy);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(10, 25, 49, 0.6);
        }

        .ai-button-secondary:hover:not(:disabled) {
            background-color: #1a3053;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(10, 25, 49, 0.8);
        }

        /* Vision Button Style (Purple) */
        .ai-button-vision {
            background-color: #9333ea;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(147, 51, 234, 0.5);
        }

        .ai-button-vision:hover:not(:disabled) {
            background-color: #7e22ce;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(147, 51, 234, 0.8);
        }

        /* Root Cause Button Style (Dark Red/Maroon) */
        .ai-button-root-cause {
            background-color: #881337;
            /* Maroon 900 */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(136, 19, 55, 0.5);
        }

        .ai-button-root-cause:hover:not(:disabled) {
            background-color: #9f1239;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(136, 19, 55, 0.8);
        }

        /* Communication Button Style (Orange) */
        .ai-button-comm {
            background-color: #F97316;
            /* Orange */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(249, 115, 22, 0.5);
        }

        .ai-button-comm:hover:not(:disabled) {
            background-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(249, 115, 22, 0.8);
        }

        /* Grounding Button Style (Green) */
        .ai-button-grounding {
            background-color: #10B981;
            /* Green */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.5);
        }

        .ai-button-grounding:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.8);
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--color-light-teal);
            /* Use light teal on dark buttons */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        .ai-button-primary .loading-spinner,
        .ai-button-vision .loading-spinner,
        .ai-button-comm .loading-spinner,
        .ai-button-grounding .loading-spinner,
        .ai-button-secondary .loading-spinner,
        .ai-button-root-cause .loading-spinner {
            border-top: 4px solid #0A1931;
            /* Darker spinner on lighter buttons */
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .image-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px var(--color-shadow-base);
        }

        .image-label {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--color-navy);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 700;
            border-top-left-radius: 0.75rem;
        }

        .observation-item {
            transition: all 0.2s;
            border-right: 4px solid transparent;
            cursor: pointer;
        }

        .observation-item:hover {
            background-color: #E6F3F3;
            /* Light teal hover effect */
            border-right-color: var(--color-teal);
        }

        .observation-item.active {
            background-color: #E6F3F3;
            /* Active state */
            border-right-color: var(--color-navy);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Image Comparison Slider Styles */
        .comparison-wrapper {
            position: relative;
            max-width: 100%;
            overflow: hidden;
            user-select: none;
            cursor: ew-resize;
            /* East-West resize cursor */
            border-radius: 0.75rem;
        }

        .comparison-wrapper img,
        .comparison-wrapper video {
            display: block;
            width: 100%;
            height: auto;
        }

        .comparison-wrapper .after-image {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 50%;
            /* Initial mask width */
            overflow: hidden;
        }

        .comparison-wrapper .after-image img,
        .comparison-wrapper .after-image video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            /* Ensure the image fills the container */
            height: auto;
        }

        .comparison-wrapper .comparison-divider {
            position: absolute;
            top: 0;
            left: 50%;
            /* Initial position */
            width: 4px;
            height: 100%;
            background-color: var(--color-teal);
            transform: translateX(-50%);
            cursor: grab;
            z-index: 10;
            box-shadow: 0 0 10px rgba(24, 165, 162, 0.8);
            border-radius: 2px;
            transition: width 0.1s ease;
        }

        .comparison-wrapper .comparison-divider:active {
            cursor: grabbing;
        }

        .comparison-wrapper .comparison-divider-handle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background-color: white;
            border: 3px solid var(--color-teal);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        .comparison-label {
            position: absolute;
            z-index: 5;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 700;
            color: white;
            border-radius: 0.5rem;
            opacity: 0.9;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .label-before {
            top: 10px;
            right: 10px;
            background-color: #B91C1C;
            /* Red */
        }

        .label-after {
            top: 10px;
            left: 10px;
            background-color: #10B981;
            /* Green */
        }

        .communication-draft {
            white-space: pre-wrap;
            text-align: right;
            direction: rtl;
            font-family: 'Tajawal', sans-serif;
            border-right: 4px solid var(--color-teal);
            padding-right: 1rem;
            line-height: 1.8;
            background-color: #f8fafc;
        }

        .kpi-insight-container {
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-top: 5px solid var(--color-navy);
        }

        .source-link {
            color: #0d9488;
            /* Teal 600 */
            text-decoration: none;
            transition: color 0.2s;
        }

        .source-link:hover {
            color: var(--color-navy);
            text-decoration: underline;
        }

        audio {
            width: 100%;
            margin-top: 10px;
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            align-items: center;
            /* Center the modal content vertically */
            justify-content: center;
            /* Center the modal content horizontally */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slide-up 0.3s ease-out;
            position: relative;
        }
        
        /* Close button styling */
        .close-btn {
            color: #aaa;
            float: left; /* Pushes to the left in RTL */
            font-size: 28px;
            font-weight: bold;
            transition: color 0.2s;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #0A1931;
            text-decoration: none;
            cursor: pointer;
        }

        /* Custom Location/Image Wrapper */
        .input-group-wrapper {
            display: flex;
            gap: 1rem;
            /* Space between inputs */
        }

        .input-group {
            flex-grow: 1;
            /* Make inputs fill available space */
            text-align: center;
        }

        /* PDF Print Styles (Hiding unnecessary elements when printing) */
        @media print {
            body {
                background-color: white !important;
                color: black !important;
                /* ุชุญุฏูุฏ ุนุฑุถ ุงูุตูุญุฉ ููู PDF */
                width: 210mm;
                /* A4 width */
                min-height: 297mm;
                /* A4 height */
                margin: 0;
            }

            .no-print,
            #observationsList,
            #hero,
            #operational-dashboard,
            #ai-features,
            footer,
            .modal {
                display: none !important;
            }

            #observationDetail {
                display: block !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }

            .kpi-insight-container,
            .bg-white {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .comparison-wrapper {
                /* Display only the "After" image in comparison view for PDF */
                cursor: default;
            }

            .comparison-divider,
            .comparison-label {
                display: none !important;
            }

            .comparison-wrapper .after-image {
                width: 100% !important;
                overflow: visible !important;
            }

            .comparison-wrapper .after-image img {
                position: static !important;
            }

            /* Adjusting details layout for print */
            .grid.grid-cols-1.md\3a grid-cols-3 {
                display: block !important;
                border: 1px solid #ccc;
                margin-bottom: 10px;
            }

            .grid.grid-cols-1.md\3a grid-cols-3>div {
                border: none !important;
                padding: 5px;
            }

            .print-logo {
                display: block !important;
            }
        }
    </style>
</head>

<body class="text-gray-800">

    <div class="w-full flex justify-start p-6 no-print" style="position: absolute; top: 0; right: 0; z-index: 50;">
        <button onclick="logout()" style="
            background-color: #f44336; /* ููู ุฃุญูุฑ ูุชุณุฌูู ุงูุฎุฑูุฌ */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            margin-left: auto; /* ูุฏูุน ุงูุฒุฑ ุฅูู ุงูุฒุงููุฉ ุงููููู ูู ููุท RTL */
        " id="logout-button" class="hover:bg-red-700 hover:shadow-lg transform hover:scale-[1.03]">
            <i data-lucide="log-out" class="w-5 h-5 ml-2"></i> ุชุณุฌูู ุงูุฎุฑูุฌ
        </button>
    </div>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <section id="hero"
            class="text-center py-12 md:py-16 bg-white rounded-3xl shadow-2xl mb-12 border-b-8 border-t-8 border-teal-100 no-print">
            <h1 class="text-5xl md:text-7xl font-extrabold text-gray-900 tracking-tight"
                style="color: var(--color-navy);">Smart HSR <span style="color: var(--color-teal);">Dashboard</span>
            </h1>
            <h2 class="text-xl md:text-3xl font-extrabold text-gray-600 mt-4">ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู
            </h2>
            <p class="mt-4 text-lg max-w-4xl mx-auto text-gray-500 font-medium">"ููุตุฉ ุชูููุฐูุฉ ุฐููุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ
                ูุงููุฑุงูุจุฉ ุงูุฑูููุฉุ ุชููุฑ ุฑุคูุฉ ุฏูููุฉ ููุฃุฏุงุก ูุชุฏุนู ุงุชุฎุงุฐ ุงููุฑุงุฑ ุงููุจูู ุนูู ุงูุจูุงูุงุช."</p>
        </section>

        <section id="observations-log" class="my-20">
            <div class="text-center mb-12 no-print">
                <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color: var(--color-navy);">ุณุฌู
                    ุงูููุงุญุธุงุช ุงูุชูุงุนูู: ุฏูุฉ ุงูุตูุฑุฉ ูุงููุต</h3>
                <p class="mt-3 text-lg text-gray-600">ุนุฑุถ ุชูุตููู ููููุงุญุธุงุช ุงูููุฏุงููุฉ ูุน ุฃุฏูุงุช ุงูุชุญููู ุงูุขูู.</p>
                <button id="add-observation-btn"
                    class="ai-button-primary rounded-full px-6 py-2 text-md font-bold mt-4 flex items-center justify-center mx-auto"
                    onclick="openModal('smartInputModal')">
                    <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i> ุฅุถุงูุฉ ููุงุญุธุฉ ุฌุฏูุฏุฉ (ุงูุฅุฏุฎุงู ุงูุฐูู)
                </button>
            </div>

            <div
                class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl grid grid-cols-1 lg:grid-cols-3 gap-8 border border-gray-200">

                <div
                    class="lg:col-span-1 border-b lg:border-b-0 lg:border-l border-gray-300 lg:pr-6 pb-6 lg:pb-0 no-print">
                    <h4 class="text-2xl font-bold mb-4" style="color: var(--color-teal);">ุชุตููุฉ ุงูููุงุญุธุงุช</h4>
                    <select id="observationFilter"
                        class="w-full p-3 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm transition-all duration-300"
                        onchange="handleFilterChange()">
                        <option value="ุงููู">ุนุฑุถ ูู ุงูููุงุญุธุงุช</option>
                        <option value="ุฌุฏูุฏ">ุฌุฏูุฏ</option>
                        <option value="ููุฏ ุงูุชูููุฐ">ููุฏ ุงูุชูููุฐ</option>
                        <option value="ุชูุช ุงููุนุงูุฌุฉ">ุชูุช ุงููุนุงูุฌุฉ</option>
                        <option value="ุฌูุฏุฉ">ุฌูุฏุฉ</option>
                        <option value="ุตูุงูุฉ">ุตูุงูุฉ</option>
                        <option value="ุณูุงูุฉ">ุณูุงูุฉ</option>
                        <option value="ุจูุฆุฉ">ุจูุฆุฉ</option>
                    </select>
                    <h4 class="text-2xl font-bold mt-8 mb-3" style="color: var(--color-navy);">ุงููููุงุญุธููุงุช</h4>
                    <div id="observationsList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                        <div class="text-center text-gray-500 mt-10">... ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช ุงูุซุงุจุชุฉ...</div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-inner">

                    <div class="print-logo hidden mb-6 p-4 border-b border-gray-300">
                        <h2 class="text-3xl font-extrabold text-gray-900" style="color: var(--color-navy);">ุชูุฑูุฑ Smart
                            HSR ุงูุชูููุฐู</h2>
                        <p id="printTitle" class="text-xl font-bold text-teal-600 mt-2"></p>
                    </div>

                    <h4 class="text-2xl font-extrabold mb-4 border-b-2 border-gray-300 pb-2"
                        style="color: var(--color-teal);">ุนุฑุถ ุงูุชูุงุตูู ูุงูุชุญููู (AI Insights)</h4>

                    <div id="observationDetail" class="hidden">

                        <div
                            class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm font-medium mb-6 p-4 bg-white rounded-xl shadow-sm border">
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุงูุนููุงู:</span>
                                <span id="detailTitle" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุงูุชุตููู:</span>
                                <span id="detailType" class="block font-bold text-teal-600"></span>
                            </div>
                            <div class="p-2">
                                <span class="block text-gray-500">ุงููููุน:</span>
                                <span id="detailLocation" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุชุงุฑูุฎ ุงูุจูุงุบ:</span>
                                <span id="detailDate" class="block font-bold text-gray-800"></span>
                            </div>
                            <div class="border-b md:border-b-0 md:border-l p-2">
                                <span class="block text-gray-500">ุญุงูุฉ ุงููุนุงูุฌุฉ:</span>
                                <span id="detailStatus"
                                    class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white"></span>
                            </div>
                            <div class="p-2">
                                <span class="block text-gray-500">ูุนุฑู ุงูุจูุงุบ:</span>
                                <span id="detailID" class="block font-bold text-gray-800"></span>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-2xl shadow-md mb-6 border-l-4 border-teal-500">
                            <h5 class="text-xl font-bold mb-3" style="color: var(--color-navy);">ูุตู ุงูููุงุญุธุฉ</h5>
                            <p id="detailDescription" class="text-gray-700 leading-relaxed"></p>
                            <div id="actionPlanContainer" class="mt-4 p-3 bg-teal-50 rounded-lg hidden">
                                <h6 class="font-bold text-teal-700">ุฎุทุฉ ุงูุนูู ุงูููุชุฑุญุฉ (Gemini AI)</h6>
                                <p id="actionPlan" class="text-sm text-teal-900 mt-1"></p>
                            </div>
                        </div>

                        <div id="resolutionNoteContainer"
                            class="bg-green-50 p-5 rounded-2xl shadow-md mb-6 border-l-4 border-green-500 hidden">
                            <h5 class="text-xl font-bold mb-3 text-green-700">๐ ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ ููุฅุบูุงู</h5>
                            <p id="resolutionNote" class="text-gray-700 leading-relaxed"></p>
                        </div>

                        <div id="imageComparisonWrapper" class="comparison-wrapper mb-6 hidden">
                            <img id="beforeImage" class="before-image w-full h-auto" alt="ุตูุฑุฉ ูุจู ุงูุฅุตูุงุญ"
                                src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
                            <div id="afterImageContainer" class="after-image">
                                <img id="afterImage" class="w-full h-auto" alt="ุตูุฑุฉ ุจุนุฏ ุงูุฅุตูุงุญ"
                                    src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==">
                            </div>
                            <div id="comparisonDivider" class="comparison-divider no-print">
                                <div class="comparison-divider-handle">
                                    <i data-lucide="arrow-left-right" class="w-4 h-4 text-teal-600"></i>
                                </div>
                            </div>
                            <span class="comparison-label label-before no-print">ูุจู</span>
                            <span class="comparison-label label-after no-print">ุจุนุฏ</span>
                        </div>

                        <div id="mediaContainer" class="image-container mb-6 hidden">
                            <div id="mediaContent" class="w-full h-auto rounded-xl">
                            </div>
                            <span class="image-label">ูุฑูู ุงูููุงุญุธุฉ</span>
                        </div>

                        <div id="noImageMessage"
                            class="bg-yellow-100 p-4 rounded-xl text-center text-yellow-800 font-medium mb-6 hidden">
                            <i data-lucide="alert-triangle" class="w-5 h-5 inline-block ml-2"></i> ูุง ุชุชููุฑ ุตูุฑุฉ ุฃู
                            ููุฏูู ููุฐู ุงูููุงุญุธุฉ.
                        </div>


                        <div id="aiAnalysisSection"
                            class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-gray-200">
                            <h5 class="text-xl font-bold mb-4" style="color: var(--color-navy);">ุฃุฏูุงุช ุงูุชุญููู ุงูุฐูู
                                (Gemini AI)</h5>
                            <div class="flex flex-wrap gap-3 no-print">
                                <button id="vision-btn"
                                    class="ai-button-vision rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="analyzeImage('vision')">
                                    <i data-lucide="eye" class="w-4 h-4 ml-2"></i> ุชุญููู ุงูุตูุฑ ุจุงูุฑุคูุฉ (Vision)
                                </button>
                                <button id="root-cause-btn"
                                    class="ai-button-root-cause rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="analyzeImage('root-cause')">
                                    <i data-lucide="microscope" class="w-4 h-4 ml-2"></i> ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู
                                </button>
                                <button id="comm-btn"
                                    class="ai-button-comm rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="generateCommunicationDraft()">
                                    <i data-lucide="send" class="w-4 h-4 ml-2"></i> ุตูุงุบุฉ ุฃูุฑ ุงูุนูู
                                </button>
                                <button id="pdf-report-btn"
                                    class="ai-button-grounding rounded-full px-4 py-2 text-sm font-bold flex items-center"
                                    onclick="generatePdfReport()">
                                    <i data-lucide="file-text" class="w-4 h-4 ml-2"></i> ุชูููุฏ ุชูุฑูุฑ PDF
                                </button>
                            </div>

                            <div id="aiResultContainer"
                                class="mt-5 p-4 bg-gray-50 rounded-xl border border-gray-200 hidden">
                                <h6 id="aiResultTitle" class="font-bold text-lg mb-2" style="color: var(--color-teal);">
                                </h6>
                                <div id="aiResultContent" class="text-gray-700"></div>
                            </div>
                        </div>

                        <div id="actionButtons"
                            class="mt-6 pt-4 border-t border-gray-300 flex justify-end gap-3 no-print">
                            <button id="updateStatusBtn"
                                class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150"
                                onclick="alert('ุชู ุชุญููู ุงูุญุงูุฉ ุฅูู ููุฏ ุงูุชูููุฐ (ุชุฌุฑูุจู)')">
                                ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู "ููุฏ ุงูุชูููุฐ"
                            </button>
                            <button id="completeObservationBtn"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150"
                                onclick="openModal('closeoutModal')">
                                <i data-lucide="lock" class="w-4 h-4 ml-2"></i> ุงูุฅุบูุงู ุงูุชูููุฐู (ุตูุฑุฉ ุจุนุฏ)
                            </button>
                            <button id="alreadyCompletedBtn"
                                class="bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150 hidden"
                                disabled>
                                <i data-lucide="check" class="w-4 h-4 ml-2"></i> ุงูููุงุญุธุฉ ูุบููุฉ ูููุซูุฉ
                            </button>
                        </div>
                    </div>

                    <div id="detailPlaceholder" class="text-center space-y-4">
                        <p class="text-gray-500 mt-16 text-lg">ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููุงุญุธุฉ ูู ุงููุงุฆูุฉ ูุนุฑุถ ุงูุตูุฑุฉ ูุงููุฐูุฑุฉ
                            ุงูุชูุตูููุฉ.</p>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M17 10h.01" />
                        </svg>
                    </div>
                </div>
            </div>
        </section>

        <section id="operational-dashboard" class="my-20 no-print">
            <div class="text-center mb-12">
                <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color: var(--color-navy);">๐
                    ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุญูููุฉ (Vital Metrics)</h3>
                <p class="mt-3 text-lg text-gray-600">ุชุชุจุน ุงูุจูุงุบุงุช ูุญุงูุฉ ุงูุชูุซูู ุจุงูุตูุฑ ูุถูุงู ููุงุกุฉ ุงูุฅุบูุงู.</p>
            </div>
            <div id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="lg:col-span-4 text-center p-8 bg-white rounded-2xl shadow-xl">
                    <h4 class="text-2xl font-bold text-gray-500">ูุง ุชูุฌุฏ ููุงุญุธุงุช ุญุงููุงู.</h4>
                    <p class="text-gray-400 mt-2">ุงูุฑุฌุงุก ุงุณุชุฎุฏุงู ุฒุฑ "ุฅุถุงูุฉ ููุงุญุธุฉ ุฌุฏูุฏุฉ" ูู ุงูุฃุนูู ููุจุฏุก.</p>
                </div>
            </div>
            <div class="mt-12 text-center">
                <button id="kpi-insight-button"
                    class="ai-button-secondary rounded-full px-8 py-3 text-lg font-bold flex items-center justify-center mx-auto"
                    onclick="generateKpiInsights()">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 ml-2"></i> โจ ุชูููุฏ ุชูุฑูุฑ ุชูููุฐู ูููุฎุต ุงูููุญุฉ (Gemini AI)
                </button>
                <div id="kpi-insight-result" class="mt-6 text-sm">
                </div>
            </div>
        </section>

        <section id="ai-features"
            class="my-20 bg-white p-8 md:p-12 rounded-3xl shadow-2xl border-t-8 border-[--color-teal] no-print">
            <div class="text-center mb-12">
                <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-3" style="color: var(--color-navy);">๐ง
                    ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู ุตููู ุงูุนูููุฉ</h3>
                <p class="mt-3 text-lg text-gray-600">ุงุณุชูุฏ ูู ููุงุฐุฌ Gemini ูุชุญููู ุงูุจูุงูุงุช ุฅูู ูุฑุงุฑุงุช ูุงุจูุฉ ููุชูููุฐ.
                </p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-7 gap-8 text-center">
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #9333ea;">๐๏ธ</span>
                    <h4 class="font-extrabold text-lg mb-1" style="color: var(--color-navy);">ุชุญููู ุงูุฑุคูุฉ</h4>
                    <p class="text-xs text-gray-600">ูุตู ุงููุดููุฉ ูุชุญุฏูุฏ ุญุงูุฉ ุงูุฅุบูุงู ุงููุซุงููุฉ.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-teal);">โ๏ธ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุฎุทุฉ ุนูู ุขููุฉ</h4>
                    <p class="text-xs text-gray-600">ุชูููุฏ ุฎุทูุงุช ุชูููุฐูุฉ ููุนุงูุฌุฉ ุงูููุงุญุธุฉ.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-teal);">๐จ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุชูููู ุงููุฎุงุทุฑ</h4>
                    <p class="text-xs text-gray-600">ุชุญุฏูุฏ ุงูุฃููููุฉ ูุงูุฅุทุงุฑ ุงูุฒููู ูู ูููู JSON.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #881337;">๐ฌ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู</h4>
                    <p class="text-xs text-gray-600">ุงูุชุฑุงุญ ุณุจุจ ุฌุฐุฑู ููุตูุญุฉ ููุงุฆูุฉ.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #F97316;">โ๏ธ</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุตูุงุบุฉ ุงูุงุชุตุงู</h4>
                    <p class="text-xs text-gray-600">ุชูููุฏ ูุณูุฏุฉ ุฃูุฑ ุนูู ุฃู ุจุฑูุฏ ุฅููุชุฑููู.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: var(--color-navy);">๐</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุชูุฑูุฑ ุงูุฅุบูุงู ุงูุตูุชู</h4>
                    <p class="text-xs text-gray-600">ุชูุฎูุต ุงูุชูุฑูุฑ ูุชุญูููู ุฅูู ููู ุตูุชู.</p>
                </div>
                <div
                    class="p-4 rounded-xl border border-gray-100 bg-gray-50 hover:shadow-lg transition-shadow duration-300 flex flex-col items-center">
                    <span class="text-4xl block mb-2" style="color: #10B981;">๐</span>
                    <h4 class="font-bold text-lg mb-1" style="color: var(--color-navy);">ุงูุจุญุซ ุนู ุงููุนุงููุฑ</h4>
                    <p class="text-xs text-gray-600">ุงุณุชุฎุฏุงู ุงูุจุญุซ ุงููุฏุนูู ูุงุณุชุญุถุงุฑ ุงููุนุงููุฑ ุงูุนุงูููุฉ.</p>
                </div>
            </div>
        </section>

        <footer class="text-center mt-20 py-12 border-t-4 border-teal-200 bg-white rounded-t-3xl shadow-2xl no-print">
            <div class="max-w-6xl mx-auto px-4">
                <h3 class="text-3xl md:text-4xl font-extrabold mb-4" style="color: var(--color-navy);"> ุงุจุฏุฃ ุฑุญูุฉ ุงูุชุญูู
                    ุงูุฑููู ูุน Smart HSR </h3>
                <p class="mt-3 text-lg md:text-xl text-gray-600 max-w-3xl mx-auto"> ูุธุงู ุฐูู ููุญูู ุจูุงูุงุช ุงูููุฏุงู ุฅูู
                    ูุฑุงุฑุงุช ุงุณุชุฑุงุชูุฌูุฉ ุชูููุฐููุฉ </p>
                <a href="http://wa.me/966507006849" target="_blank"
                    class="mt-8 inline-block bg-[--color-teal] text-white font-bold py-4 px-12 rounded-full text-xl hover:bg-[--color-navy] transition-all duration-300 transform hover:scale-105 shadow-lg">
                    ุงุทูุจ ุนุฑุถูุง ุชุฌุฑูุจููุง ุงูุขู </a>
                <div class="mt-12 pt-8 border-t border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600 mb-6">
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">ุญูู ุงููุธุงู</h4>
                            <p>ูุธุงู Smart HSR ูููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">ุงูุฏุนู ุงูููู</h4>
                            <p>Blumark24@gmail.com</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">ุงููุจูุนุงุช ูุงูุงุณุชูุณุงุฑุงุช</h4>
                            <p>0507006849</p>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">
                        <p class="mb-2">&copy; 2025 Smart HSR. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
                        <p id="userInfo">ุชู ุชุญููู ุงูุจูุงูุงุช ุจูุฌุงุญ (ูุถุน ุซุงุจุช)</p>
                    </div>
                </div>
            </div>
        </footer>

    </main>

    <div id="smartInputModal" class="modal no-print">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('smartInputModal')">&times;</span>
            <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b" style="color: var(--color-navy);">ูุญุฏุฉ ุงูุฅุฏุฎุงู ุงูุฐูู
                ููููุงุญุธุงุช (Smart HSR)</h2>
            <div id="modalStep1">
                <p class="text-lg text-gray-600 mb-4">ุงูุฎุทูุฉ 1: ุฃุฏุฎู ุชูุงุตูู ุงูููุงุญุธุฉ (ุงููุตุ ุงููููุนุ ุงูุตูุฑุฉ/ุงูููุฏูู)</p>
                <textarea id="rawObservationInput" rows="5"
                    class="w-full p-4 border border-gray-300 rounded-xl focus:ring-[--color-teal] focus:border-[--color-teal] text-gray-700 shadow-sm"
                    placeholder="ูุซุงู: ููุฌุฏ ุชุฌูุน ููููุงู ุนูู ุทุฑูู ุงูุฎุฏูุฉ ุนูุฏ ุงููููู 52 ุจุงุชุฌุงู ุงูุดุฑูุ ูุชุณุจุจ ูู ุงูุฒูุงู ุงูุณูุงุฑุงุช. ูุญุชุงุฌ ุฅูู ุชุตุฑูู ููุฑู."
                    oninput="checkSmartInputState()"></textarea>
                <div class="mt-4 input-group-wrapper">
                    <div
                        class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
                        <label for="locationStatus" class="block text-sm font-medium text-gray-700 mb-2">ุงููููุน
                            ุงูุฌุบุฑุงูู (GPS):</label>
                        <p id="locationStatus" class="text-sm font-semibold text-gray-500">ูู ูุชู ุงูุชุญุฏูุฏ ุจุนุฏ</p>
                        <input type="hidden" id="inputLatitude">
                        <input type="hidden" id="inputLongitude">
                        <button id="getLocationBtn"
                            class="ai-button-primary rounded-full px-4 py-2 text-sm font-bold mt-2 flex items-center justify-center mx-auto"
                            onclick="getLocation()" type="button">
                            <i data-lucide="map-pin" class="w-4 h-4 ml-2"></i> ุชุญุฏูุฏ ูููุนู ุงูุญุงูู
                        </button>
                    </div>
                    <div
                        class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-teal-500 transition-colors">
                        <label for="imageInput" class="block text-sm font-medium text-gray-700 mb-2">ุตูุฑุฉ/ููุฏูู
                            (ุงุฎุชูุงุฑู):</label>
                        <input type="file" id="imageInput" accept="image/*,video/*"
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100 cursor-pointer"
                            onchange="checkSmartInputState()">
                    </div>
                </div>
                <button id="processSmartInputBtn" disabled
                    class="ai-button-secondary rounded-full px-8 py-3 text-lg font-bold mt-8 flex items-center justify-center mx-auto disabled:opacity-50 disabled:cursor-not-allowed"
                    onclick="processSmartInput()">
                    <i data-lucide="zap" class="w-5 h-5 ml-2"></i> ุชุญููู ูุฅุฏุฎุงู ุฐูู (Gemini AI)
                </button>
            </div>

            <div id="modalStep2" class="hidden">
                <p class="text-lg text-gray-600 mb-4">ุงูุฎุทูุฉ 2: ูุฑุงุฌุนุฉ ุงูููุงุญุธุฉ ุงููุตุงุบุฉ ุจูุงุณุทุฉ Gemini AI</p>
                <div id="aiDraft" class="bg-gray-100 p-4 rounded-xl border border-gray-200 mb-6">
                    <h4 class="font-bold text-lg mb-2" style="color: var(--color-navy);">ุงูููุงุญุธุฉ ุงููุตุงุบุฉ:</h4>
                    <p id="draftDescription" class="text-gray-700 leading-relaxed"></p>
                    <div class="mt-4 p-3 bg-teal-50 rounded-lg">
                        <h6 class="font-bold text-teal-700">ุงูุชุตููู ุงูููุชุฑุญ:</h6>
                        <span id="draftType" class="text-sm text-teal-900 mt-1 font-semibold"></span>
                    </div>
                </div>
                <button
                    class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-150"
                    onclick="backToStep1()">
                    <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i> ุชุนุฏูู ุงููุฏุฎูุงุช
                </button>
                <button
                    class="ai-button-primary float-left font-bold py-2 px-4 rounded-full shadow-lg transition duration-150"
                    onclick="submitObservation()">
                    <i data-lucide="check-circle" class="w-4 h-4 ml-2"></i> ุงุนุชูุงุฏ ูุฅุถุงูุฉ ุงูููุงุญุธุฉ
                </button>
            </div>

            <div id="modalLoading" class="hidden text-center py-10">
                <div class="loading-spinner mx-auto border-teal-500 border-t-teal-100 w-10 h-10"></div>
                <p class="text-lg text-gray-600 mt-4">ุฌุงุฑู ุชุญููู ุงูููุงุญุธุฉ ุจูุงุณุทุฉ Gemini AI...</p>
            </div>
        </div>
    </div>

    <div id="closeoutModal" class="modal no-print">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('closeoutModal')">&times;</span>
            <h2 class="text-3xl font-extrabold mb-6 pb-2 border-b text-red-600">ุงูุฅุบูุงู ุงูุชูููุฐู ูุงูููุงุฑูุฉ</h2>
            <p class="text-lg text-gray-600 mb-4">ูุฅุบูุงู ุงูููุงุญุธุฉุ ูุฑุฌู ุฅุฑูุงู ุตูุฑุฉ "ุจุนุฏ ุงูุฅุตูุงุญ" ููุชุงุจุฉ ูุฐูุฑุฉ ุฎุชุงููุฉ.</p>

            <div class="mt-4 input-group-wrapper">
                <div
                    class="input-group p-4 border-2 border-dashed border-gray-300 rounded-xl bg-white hover:border-green-500 transition-colors">
                    <label for="closeoutImageInput" class="block text-sm font-medium text-gray-700 mb-2">ุตูุฑุฉ ุจุนุฏ
                        ุงูุฅุตูุงุญ (ูุทููุจ):</label>
                    <input type="file" id="closeoutImageInput" accept="image/*" required
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer"
                        onchange="checkCloseoutState()">
                </div>
            </div>

            <h4 class="text-xl font-bold mt-6 mb-3 text-gray-800">ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ (Resolution Note)</h4>
            <textarea id="resolutionNoteInput" rows="4" required
                class="w-full p-4 border border-gray-300 rounded-xl focus:ring-green-600 focus:border-green-600 text-gray-700 shadow-sm"
                placeholder="ูุซุงู: ุชู ุชูููุฐ ุฎุทุฉ ุนูู ููุฑูุฉ ูุชุตุฑูู ุงูููุงู ูุฅุตูุงุญ ุงูุดู ูู ุงูุทุฑูู ุจุงุณุชุฎุฏุงู ููุงุฏ ุณุฑูุนุฉ ุงูุฌูุงู. ุชู ุงูุชุฃูุฏ ูู ูุนุงููุฉ ุงูุชุตุฑูู ุจุนุฏ ูุทูู ุฃูุทุงุฑ ุฎูููุฉ. ูุฑุฌู ุฅุบูุงู ุงูุจูุงุบ."
                oninput="checkCloseoutState()"></textarea>

            <button id="closeoutProcessBtn" disabled
                class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-150 mt-6 float-left disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="submitCloseout()">
                <i data-lucide="check-square" class="w-5 h-5 ml-2"></i> ุชุฃููุฏ ุฅุบูุงู ุงูููุงุญุธุฉ
            </button>
            <div class="clearfix"></div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

        // ๐ด ูุง ุชูู ุจุชุนุฏูู ูุฐุง ุงูููุฏ - ูุฐุง ูู ููุฏ ุฑุจุท ูุดุฑูุนู ุจู Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC5HTAq-LeJn4GObn08REwKdqIeokKmwds",
            authDomain: "smart-hsr.firebaseapp.com",
            projectId: "smart-hsr",
            storageBucket: "smart-hsr.firebasestorage.app",
            messagingSenderId: "885545362431",
            appId: "1:885545362431:web:2487096393f0fcbf29bdca"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // โ ูุฐุง ุงูุฌุฒุก ูุญูู ููุญุฉ ุงูุชุญูู ูู ุงูุฏุฎูู ุงููุจุงุดุฑ ุจุฏูู ุชุณุฌูู
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // ุงูุชุฃูุฏ ูู ุฃู ุงูุชูุฌูู ูู login.html ูุชู ููุท ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ููุฌูุฏุงู
                window.location.href = "login.html";
                document.body.style.display = 'none'; // ูุฅุฎูุงุก ุงููุญุชูู ูุจู ุงูุชุญููู
            } else {
                console.log("ุงููุณุชุฎุฏู ูุณุฌู ุงูุฏุฎูู:", user.uid);
                document.body.style.display = 'block'; // ุฅุธูุงุฑ ุงููุญุชูู ุจุนุฏ ุงูุชุญูู
            }
        });

        // โ ูุฐู ุงูุฏุงูุฉ ูุชู ุงุณุชุฏุนุงุคูุง ุจุงูููุฑ ุนูู ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ (onclick="logout()")
        window.logout = function() {
            signOut(auth).then(() => {
                // ุจุนุฏ ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญุ ูุชู ุงูุชูุฌูู ูุตูุญุฉ ุงูุฏุฎูู
                window.location.href = "login.html";
            }).catch((error) => {
                console.error("ุฎุทุฃ ูู ุชุณุฌูู ุงูุฎุฑูุฌ:", error);
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุฎุฑูุฌ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
            });
        }
    </script>

    <script>
        // =========================================================================
        // ๐ด๐ด๐ด ุจูุงูุงุช ุงูููุงุญุธุงุช (ุชุจุฏุฃ ูุงุฑุบุฉ ูุฌุงูุฒุฉ ูุงุณุชูุจุงู ุงูุฅุฏุฎุงู) ๐ด๐ด๐ด
        // =========================================================================
        let observationsData = []; 
        
        let currentSelectedObservation = null; 
        let isComparisonDragging = false;
        let comparisonWrapper;
        let comparisonDivider;
        let afterImageContainer;


        // =========================================================================
        // ๐ ุฏูุงู ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ (KPIs)
        // =========================================================================

        // ุฏุงูุฉ ุชุญุณุจ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ (KPIs)
        function calculateKPIs() {
            if (observationsData.length === 0) {
                return {
                    totalReports: 0,
                    openReports: 0,
                    closedReports: 0,
                    imageCoverage: 0,
                    missingImages: 0
                };
            }

            const totalReports = observationsData.length;
            const openReports = observationsData.filter(obs => obs.status === 'ุฌุฏูุฏ' || obs.status === 'ููุฏ ุงูุชูููุฐ').length;
            const closedReports = totalReports - openReports;
            const reportsWithImage = observationsData.filter(obs => obs.imageUrl && obs.imageUrl !== 'placeholder.jpg').length;
            const imageCoverage = totalReports > 0 ? Math.round((reportsWithImage / totalReports) * 100) : 0;
            const missingImages = totalReports - reportsWithImage;

            return { totalReports, openReports, closedReports, imageCoverage, missingImages };
        }

        // ุฏุงูุฉ ูุนุฑุถ ูุคุดุฑุงุช ุงูุฃุฏุงุก
        function renderKPIs() {
            const kpis = calculateKPIs();
            const kpiContainer = document.getElementById('kpiContainer');
            
             if (kpis.totalReports === 0) {
                 kpiContainer.innerHTML = `
                    <div class="lg:col-span-4 text-center p-8 bg-white rounded-2xl shadow-xl">
                        <h4 class="text-2xl font-bold text-gray-500">ูุง ุชูุฌุฏ ููุงุญุธุงุช ุญุงููุงู.</h4>
                        <p class="text-gray-400 mt-2">ุงูุฑุฌุงุก ุงุณุชุฎุฏุงู ุฒุฑ "ุฅุถุงูุฉ ููุงุญุธุฉ ุฌุฏูุฏุฉ" ูู ุงูุฃุนูู ููุจุฏุก.</p>
                    </div>
                 `;
                 return;
             }


            const kpiCards = [
                {
                    title: "ุฅุฌูุงูู ุงูููุงุญุธุงุช",
                    value: kpis.totalReports,
                    icon: "file-text",
                    gradientClass: "kpi-images-gradient"
                },
                {
                    title: "ุงูููุงุญุธุงุช ุงูููุชูุญุฉ",
                    value: kpis.openReports,
                    icon: "bell",
                    gradientClass: "kpi-open-gradient"
                },
                {
                    title: "ุงูููุงุญุธุงุช ุงููุบููุฉ",
                    value: kpis.closedReports,
                    icon: "check-circle",
                    gradientClass: "kpi-closed-gradient"
                },
                {
                    title: "ุชุบุทูุฉ ุงูุตูุฑ (%)",
                    value: `${kpis.imageCoverage}%`,
                    icon: "camera",
                    gradientClass: "kpi-closed-gradient" // ุชู ุชุนุฏูู ุงูููู ูู Green/Teal ููุชูุงุณุจ ูุน ุงููุณุจุฉ ุงููุฆููุฉ
                }
            ];

            kpiContainer.innerHTML = kpiCards.map(kpi => `
                <div class="kpi-card-professional ${kpi.gradientClass} p-6">
                    <div class="flex items-center justify-between">
                        <i data-lucide="${kpi.icon}" class="w-8 h-8 opacity-80"></i>
                        <p class="text-lg font-medium opacity-90">${kpi.title}</p>
                    </div>
                    <p class="text-4xl font-extrabold mt-3">${kpi.value}</p>
                </div>
            `).join('');

            lucide.createIcons();
        }

        // ูุญุงูุงุฉ ุชูููุฏ ุชูุฑูุฑ KPIs
        function generateKpiInsights() {
            if (observationsData.length === 0) {
                return alert("ูุง ูููู ุชูููุฏ ุชูุฑูุฑ ุชูููุฐู ูุนุฏู ูุฌูุฏ ุจูุงูุงุช.");
            }
            
            setAILoading('kpi-insight-button', 'ุฌุงุฑู ุชูููุฏ ุงูุชูุฑูุฑ...');
            
            const kpis = calculateKPIs();
            const insightContent = `
                ุชุธูุฑ ุงูุจูุงูุงุช ุฃู ููุงู <span class="font-bold text-red-600">${kpis.openReports}</span> ููุงุญุธุงุช ููุชูุญุฉุ ูู ุฃุตู <span class="font-bold text-teal-700">${kpis.totalReports}</span> ููุงุญุธุฉ ุฅุฌูุงูุงู. ูุนุฏู ุงูุฅุบูุงู ูู <span class="font-bold text-green-600">${kpis.closedReports}</span> ููุงุญุธุฉ ูุบููุฉุ ูุน ุชุบุทูุฉ ุตูุฑ ุจูุณุจุฉ <span class="font-bold text-blue-600">${kpis.imageCoverage}%</span>. ูุฌุจ ุนูู ุงููุฑูู ุงูุชูููุฐู ูุฑุงุฌุนุฉ ุฎุทุท ุงูุนูู ุงูููุฑูุฉ ูุชูููู ูุชูุณุท ุฒูู ุงูุฅุบูุงู ูุงูุชุฑููุฒ ุนูู ุชูุซูู ุฌููุน ุงูููุงุญุธุงุช ุจุงูุตูุฑ ูุถูุงู ุฌูุฏุฉ ุงูุฅุบูุงู.
            `;

            setTimeout(() => {
                document.getElementById('kpi-insight-result').innerHTML = `
                    <div class="kpi-insight-container p-4 mt-4 bg-white rounded-2xl shadow-md border-t-4 border-teal-500">
                        <p class="font-bold text-lg" style="color: var(--color-navy);">ููุฎุต ุชูููุฐู ููุชุฑุญ (Gemini AI):</p>
                        <p class="text-gray-700 mt-2">${insightContent}</p>
                    </div>
                `;
                resetAIButton('kpi-insight-button', 'bar-chart-3', 'โจ ุชูููุฏ ุชูุฑูุฑ ุชูููุฐู ูููุฎุต ุงูููุญุฉ (Gemini AI)');
            }, 3000);
        }

        // =========================================================================
        // ๐ผ๏ธ ุฏูุงู ุนุฑุถ ุงููุงุฆูุฉ ูุงูุชูุงุตูู
        // =========================================================================
        
        // ุฏุงูุฉ ูุนุฑุถ ูุงุฆูุฉ ุงูููุงุญุธุงุช
        function renderObservationsList(data) {
            const listElement = document.getElementById('observationsList');
            if (data.length === 0) {
                listElement.innerHTML = `<div class="p-4 text-center text-gray-500 bg-gray-50 rounded-lg">ูุง ุชูุฌุฏ ููุงุญุธุงุช ุญุงููุงู ูู ูุฐุง ุงูุชุตููู.</div>`;
                return;
            }

            listElement.innerHTML = data.map(obs => {
                const statusClass = obs.status === 'ุชูุช ุงููุนุงูุฌุฉ' ? 'text-green-600' : 
                                    obs.status === 'ููุฏ ุงูุชูููุฐ' ? 'text-yellow-600' : 'text-red-600';
                return `
                    <div class="observation-item p-3 border rounded-xl shadow-sm bg-white" 
                         data-id="${obs.id}" 
                         onclick="showObservationDetail(${obs.id})">
                        <h5 class="text-sm font-bold text-gray-900">${obs.title}</h5>
                        <p class="text-xs ${statusClass} font-semibold mt-1">${obs.status} - ${obs.type}</p>
                    </div>
                `;
            }).join('');

            if (currentSelectedObservation) {
                const activeItem = listElement.querySelector(`[data-id="${currentSelectedObservation.id}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }
        
        // ุฏุงูุฉ ูุนุฑุถ ุงูุชูุงุตูู (ุชู ุชุถููููุง ูู ุงูููุฏ ุงูุณุงุจู)
        // ... (ุชู ุฏูุฌ ุฏุงูุฉ showObservationDetail ุฃุฏูุงู)


        // =========================================================================
        // ๐งฉ ุงูุฏูุงู ุงูุฃุณุงุณูุฉ ูุนูู ุงูู Modals ู ุงูุฅุฏุฎุงู ุงูุฐูู
        // =========================================================================

        // ุฏุงูุฉ ุงูุชุญูู ุจูุชุญ ูุฅุบูุงู ุงูููุงูุฐ ุงูููุจุซูุฉ
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            if (modalId === 'smartInputModal') {
                backToStep1();
            }
        }

        // ุฏุงูุฉ ููุนูุฏุฉ ุฅูู ุงูุฎุทูุฉ ุงูุฃููู ูู ุงูุฅุฏุฎุงู ุงูุฐูู
        function backToStep1() {
            document.getElementById('modalStep1').classList.remove('hidden');
            document.getElementById('modalStep2').classList.add('hidden');
            document.getElementById('modalLoading').classList.add('hidden');
        }

        // ุฏุงูุฉ ูุญุต ุญุงูุฉ ุญููู ุงูุฅุฏุฎุงู ุงูุฐูู ูุชูุนูู ุฒุฑ ุงููุนุงูุฌุฉ
        function checkSmartInputState() {
            const rawInput = document.getElementById('rawObservationInput').value.trim();
            const processBtn = document.getElementById('processSmartInputBtn');
            
            if (rawInput.length > 10) { 
                processBtn.disabled = false;
                processBtn.innerHTML = `<i data-lucide="zap" class="w-5 h-5 ml-2"></i> ุชุญููู ูุฅุฏุฎุงู ุฐูู (Gemini AI)`;
            } else {
                processBtn.disabled = true;
                processBtn.innerHTML = `<i data-lucide="zap" class="w-5 h-5 ml-2"></i> ุชุญููู ูุฅุฏุฎุงู ุฐูู (Gemini AI)`;
            }
            lucide.createIcons();
        }


        // =========================================================================
        // ๐ ูุธุงุฆู ุงููููุน ุงูุฌุบุฑุงูู (Geolocation)
        // =========================================================================

        function getLocation() {
            const statusElement = document.getElementById('locationStatus');
            const latInput = document.getElementById('inputLatitude');
            const lonInput = document.getElementById('inputLongitude');
            const btn = document.getElementById('getLocationBtn');

            if (navigator.geolocation) {
                statusElement.innerText = "ุฌุงุฑู ุชุญุฏูุฏ ุงููููุน...";
                btn.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        latInput.value = lat;
                        lonInput.value = lon;
                        statusElement.innerText = `ุชู ุงูุชุญุฏูุฏ: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                        btn.disabled = false;
                        btn.innerHTML = `<i data-lucide="check" class="w-4 h-4 ml-2"></i> ุชู ุงูุชุญุฏูุฏ`;
                        lucide.createIcons();
                    },
                    (error) => {
                        statusElement.innerText = "ูุดู ุงูุชุญุฏูุฏ (ุงูุฑุฌุงุก ุชูุนูู ุงููููุน)";
                        latInput.value = "";
                        lonInput.value = "";
                        btn.disabled = false;
                        btn.innerHTML = `<i data-lucide="map-pin" class="w-4 h-4 ml-2"></i> ุชุญุฏูุฏ ูููุนู ุงูุญุงูู`;
                        lucide.createIcons();
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                statusElement.innerText = "ุงููุชุตูุญ ูุง ูุฏุนู ุชุญุฏูุฏ ุงููููุน ุงูุฌุบุฑุงูู.";
            }
        }


        // =========================================================================
        // ๐ง ูุญุงูุงุฉ ุนูููุฉ ุงูุฅุฏุฎุงู ุงูุฐูู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู (Gemini Mock)
        // =========================================================================

        async function processSmartInput() {
            const rawInput = document.getElementById('rawObservationInput').value.trim();
            const location = document.getElementById('locationStatus').innerText;
            // const imageFile = document.getElementById('imageInput').files[0]; // ูุง ูุญุชุงุฌู ูู ูุฐู ุงูุฏุงูุฉ

            // ุฅุธูุงุฑ ุญุงูุฉ ุงูุชุญููู ูุฅุฎูุงุก ุญููู ุงูุฅุฏุฎุงู
            document.getElementById('modalStep1').classList.add('hidden');
            document.getElementById('modalLoading').classList.remove('hidden');

            // ูุญุงูุงุฉ ุชุฃุฎูุฑ ุงูุชุญููู (3 ุซูุงูู)
            await new Promise(resolve => setTimeout(resolve, 3000));

            // ูุชุงุฆุฌ ูุญุงูุงุฉ ุงูุชุญููู ุงูุฐูู (Gemini AI Response)
            const mockAnalysis = {
                draftDescription: `ุจูุงุกู ุนูู ููุงุญุธุชูู ุญูู "${rawInput.substring(0, 50)}..."ุ ุชู ุตูุงุบุฉ ุงูุจูุงุบ ุงูุชุงูู ุจุดูู ุฑุณูู: ${rawInput}. ุงููููุน ุงูุฌุบุฑุงูู ุงูุฐู ุชู ุชุญุฏูุฏู ูู (${location}). ููุตู ุจุงูุชุฏุฎู ุงูุณุฑูุน ูุชูููู ุงูุฃุถุฑุงุฑ ุงููุญุชููุฉ.`,
                type: (rawInput.includes("ููุงู") || rawInput.includes("ุตูุงูุฉ") || rawInput.includes("ุชุตุฑูู")) ? "ุตูุงูุฉ" : 
                      (rawInput.includes("ุณูุงูุฉ") || rawInput.includes("ุฎุทุฑ") || rawInput.includes("ุงูุฒูุงู")) ? "ุณูุงูุฉ" : "ุฌูุฏุฉ"
            };
            
            // ุนุฑุถ ูุชุงุฆุฌ ุงูุชุญููู ูููุฑุงุฌุนุฉ
            document.getElementById('draftDescription').innerText = mockAnalysis.draftDescription;
            document.getElementById('draftType').innerText = mockAnalysis.type;

            // ุงูุงูุชูุงู ููุฎุทูุฉ 2
            document.getElementById('modalLoading').classList.add('hidden');
            document.getElementById('modalStep2').classList.remove('hidden');
        }

        // =========================================================================
        // ๐พ ุฏุงูุฉ ุฅุถุงูุฉ ุงูููุงุญุธุฉ (Submit)
        // =========================================================================

        function submitObservation() {
            const rawInput = document.getElementById('rawObservationInput').value.trim();
            const lat = document.getElementById('inputLatitude').value;
            const lon = document.getElementById('inputLongitude').value;
            const imageFile = document.getElementById('imageInput').files[0];
            const draftedDescription = document.getElementById('draftDescription').innerText;
            const draftedType = document.getElementById('draftType').innerText;

            const newId = observationsData.length > 0 ? observationsData[observationsData.length - 1].id + 1 : 1;
            const currentDate = new Date().toISOString().split('T')[0];

            let imageUrl = 'placeholder.jpg'; 
            if (imageFile) {
                // ุงุณุชุฎุฏุงู ุฑุงุจุท ูุญูู ูุคูุช ููููู ุงููุฑูู
                imageUrl = URL.createObjectURL(imageFile); 
            }

            const newObservation = {
                id: newId,
                title: `ุจูุงุบ ููุฏุงูู ุฌุฏูุฏ - ${draftedType}`,
                description: draftedDescription,
                type: draftedType,
                location: lat && lon ? `ุงูุฅุญุฏุงุซูุงุช: ${lat}, ${lon}` : "ูู ูุชู ุชุญุฏูุฏ ุงููููุน",
                date: currentDate,
                status: 'ุฌุฏูุฏ',
                imageUrl: imageUrl,
                resolutionNote: null,
                afterImageUrl: null,
                isComparative: false
            };

            observationsData.push(newObservation);

            // ุฅุนุงุฏุฉ ุชุญููู ูุงุฌูุฉ ุงููุณุชุฎุฏู ูุนุฑุถ ุงูููุงุญุธุฉ ุงูุฌุฏูุฏุฉ
            calculateAndRenderAll();
            
            // ุฅุบูุงู ุงูููุฏุงู ูุชุตููุฑ ุงูุญููู
            closeModal('smartInputModal');
            document.getElementById('rawObservationInput').value = '';
            document.getElementById('imageInput').value = ''; 
            document.getElementById('locationStatus').innerText = "ูู ูุชู ุงูุชุญุฏูุฏ ุจุนุฏ";
            document.getElementById('inputLatitude').value = '';
            document.getElementById('inputLongitude').value = '';
            
            // ุชุญุฏูุฏ ุงูููุงุญุธุฉ ุงูุฌุฏูุฏุฉ ูุนุฑุถ ุชูุงุตูููุง
            currentSelectedObservation = newObservation;
            showObservationDetail(newId);
            
            // alert(`ุชูุช ุฅุถุงูุฉ ุงูููุงุญุธุฉ ุฑูู ${newId} ุจูุฌุงุญ!`);
        }


        // =========================================================================
        // ๐ผ๏ธ ุฏุงูุฉ ุฅุบูุงู ุงูููุงุญุธุฉ (Closeout)
        // =========================================================================

        function checkCloseoutState() {
            const note = document.getElementById('resolutionNoteInput').value.trim();
            const image = document.getElementById('closeoutImageInput').files[0];
            const btn = document.getElementById('closeoutProcessBtn');

            if (note.length > 20 && image) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        function submitCloseout() {
            if (!currentSelectedObservation) {
                alert("ูุฑุฌู ุงุฎุชูุงุฑ ููุงุญุธุฉ ุฃููุงู.");
                closeModal('closeoutModal');
                return;
            }
            if (currentSelectedObservation.status !== 'ุฌุฏูุฏ' && currentSelectedObservation.status !== 'ููุฏ ุงูุชูููุฐ') {
                 alert("ุงูููุงุญุธุฉ ูุบููุฉ ูุณุจูุงู.");
                 closeModal('closeoutModal');
                 return;
            }


            const resolutionNote = document.getElementById('resolutionNoteInput').value.trim();
            const closeoutImageFile = document.getElementById('closeoutImageInput').files[0];

            if (!resolutionNote || !closeoutImageFile) {
                 alert("ุงูุฑุฌุงุก ุฅุฑูุงู ุงูุตูุฑุฉ ููุชุงุจุฉ ุงููุฐูุฑุฉ ุงูุฎุชุงููุฉ.");
                 return;
            }

            // ูุญุงูุงุฉ ุญูุธ ุงูุตูุฑุฉ ูุงูุญุงูุฉ
            const afterImageUrl = closeoutImageFile ? URL.createObjectURL(closeoutImageFile) : null;
            
            // ุชุญุฏูุซ ุจูุงูุงุช ุงูููุงุญุธุฉ ูู ุงููุตูููุฉ
            const obsIndex = observationsData.findIndex(obs => obs.id === currentSelectedObservation.id);
            if (obsIndex !== -1) {
                observationsData[obsIndex].status = 'ุชูุช ุงููุนุงูุฌุฉ';
                observationsData[obsIndex].resolutionNote = resolutionNote;
                observationsData[obsIndex].afterImageUrl = afterImageUrl;
                observationsData[obsIndex].isComparative = true;
                
                currentSelectedObservation = observationsData[obsIndex]; // ุชุญุฏูุซ ุงููุงุฆู ุงูุญุงูู
            }

            // ุฅุนุงุฏุฉ ุนุฑุถ ููุญุฉ ุงูููุงุฏุฉ ูุชุญุฏูุซ ุงูุชูุงุตูู
            calculateAndRenderAll();
            showObservationDetail(currentSelectedObservation.id);
            
            // ุฅุบูุงู ุงูููุฏุงู ูุชุตููุฑ ุงูุญููู
            closeModal('closeoutModal');
            document.getElementById('resolutionNoteInput').value = '';
            document.getElementById('closeoutImageInput').value = ''; 
            
            // alert(`ุชู ุฅุบูุงู ุงูููุงุญุธุฉ ุฑูู ${currentSelectedObservation.id} ุจูุฌุงุญ ูุชูุซูููุง.`);
        }

        // =========================================================================
        // ๐ผ๏ธ ุฏุงูุฉ ุงูููุงุฑูุฉ ุจูู ุงูุตูุฑ (Before/After Slider)
        // =========================================================================

        function setupImageComparison() {
            comparisonWrapper = document.getElementById('imageComparisonWrapper');
            comparisonDivider = document.getElementById('comparisonDivider');
            afterImageContainer = document.getElementById('afterImageContainer');

            if (!comparisonWrapper || !comparisonDivider || !afterImageContainer) return;

            // Resetting initial state
            afterImageContainer.style.width = '50%';
            comparisonDivider.style.left = '50%';
            isComparisonDragging = false; // Reset drag state

            const moveDivider = (e) => {
                if (!isComparisonDragging) return;

                const rect = comparisonWrapper.getBoundingClientRect();
                let clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                let x = clientX - rect.left;
                
                // Clamp x to be within the bounds of the wrapper
                x = Math.max(0, Math.min(x, rect.width));

                const percentage = (x / rect.width) * 100;

                afterImageContainer.style.width = `${percentage}%`;
                comparisonDivider.style.left = `${percentage}%`;
            };

            const startDrag = (e) => {
                isComparisonDragging = true;
                comparisonWrapper.style.cursor = 'grabbing';
                e.preventDefault(); // Prevent text selection
            };

            const endDrag = () => {
                isComparisonDragging = false;
                comparisonWrapper.style.cursor = 'ew-resize';
            };

            // Mouse events
            comparisonDivider.onmousedown = startDrag;
            document.onmousemove = moveDivider;
            document.onmouseup = endDrag;

            // Touch events for mobile
            comparisonDivider.ontouchstart = startDrag;
            document.ontouchmove = moveDivider;
            document.ontouchend = endDrag;
        }


        // =========================================================================
        // โ๏ธ ูุญุงูุงุฉ ุฏูุงู ุงูุชุญููู ุงูุขูู ููุฐูุงุก ุงูุงุตุทูุงุนู (Gemini AI Mock)
        // =========================================================================

        function setAILoading(btnId, loadingText) {
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<div class="loading-spinner"></div> ${loadingText}`;
                lucide.createIcons();
            }
        }

        function resetAIButton(btnId, originalIcon, originalText) {
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="${originalIcon}" class="w-4 h-4 ml-2"></i> ${originalText}`;
                lucide.createIcons();
            }
        }

        function displayAIResult(title, content, type = 'text') {
            const container = document.getElementById('aiResultContainer');
            document.getElementById('aiResultTitle').innerText = title;
            const contentElement = document.getElementById('aiResultContent');
            container.classList.remove('hidden');

            if (type === 'comm') {
                contentElement.innerHTML = `<div class="communication-draft p-4 rounded-xl shadow-inner">${content}</div>`;
            } else {
                contentElement.innerText = content;
            }
        }

        // ูุญุงูุงุฉ ุชุญููู ุงูุตูุฑ ุจุงูุฑุคูุฉ (Vision)
        function analyzeImage(feature) {
            if (!currentSelectedObservation) return alert("ูุฑุฌู ุงุฎุชูุงุฑ ููุงุญุธุฉ ุฃููุงู.");
            if (!currentSelectedObservation.imageUrl || currentSelectedObservation.imageUrl === 'placeholder.jpg') {
                return alert("ูุง ุชูุฌุฏ ุตูุฑุฉ ููุฑููุฉ ูุชุญููููุง ุจุงูุฑุคูุฉ ูู ูุฐู ุงูููุงุญุธุฉ.");
            }
            
            let btnId, originalText, originalIcon, title, mockContent;

            if (feature === 'vision') {
                btnId = 'vision-btn';
                originalText = 'ุชุญููู ุงูุตูุฑ ุจุงูุฑุคูุฉ (Vision)';
                originalIcon = 'eye';
                title = 'ูุชุงุฆุฌ ุชุญููู ุงูุฑุคูุฉ (Gemini Vision)';
                mockContent = `
                    ุจุชุญููู ุงูุตูุฑุฉ ุงููุฑููุฉุ ุชู ุชุญุฏูุฏ ุฃู ุงููุดููุฉ ูู 'ุชุฌูุน ููุงู ุณุทุญูุฉ ูุจูุฑุฉ' ูู ููุทูุฉ ุบูุฑ ูุฎุตุตุฉ ููุชุตุฑููุ ููุง ูุดูุฑ ุฅูู ูุดู ูู ุงูุจููุฉ ุงูุชุญุชูุฉ. ููุตู ุจูุนุงูุฌุฉ ุงูุชุตุฑูู ููุฑุงู. ุญุงูุฉ ุงูุฅุบูุงู ุงููุซุงููุฉ: ูุฌุจ ุฃู ุชููู ุงูููุทูุฉ ุฌุงูุฉ ุชูุงูุงู.
                `;
            } else if (feature === 'root-cause') {
                btnId = 'root-cause-btn';
                originalText = 'ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู';
                originalIcon = 'microscope';
                title = 'ุชุญููู ุงูุณุจุจ ุงูุฌุฐุฑู (Root Cause Analysis)';
                mockContent = `
                    ุงูุณุจุจ ุงูุฌุฐุฑู ุงูููุชุฑุญ: ุนุฏู ููุงูุฉ ุงูุตุฑู ูู ุชุตููู ุงูุทุฑูู (Design Flaw) ุฃู ุงูุณุฏุงุฏ ุฎุทูุท ุงูุชุตุฑูู ุจุณุจุจ ุงูููุงูุงุช (Maintenance Failure). 
                    ูุตูุญุฉ ููุงุฆูุฉ: ูุญุต ุฏูุฑู ูุฎุทูุท ุงูุชุตุฑูู ูู 60 ูููุงู ูุชุนุฏูู ุงูููู ุงูุทููู ููุทุฑูู ูู ุชูู ุงูููุทูุฉ.
                `;
            }
            
            setAILoading(btnId, 'ุฌุงุฑู ุงูุชุญููู...');
            
            setTimeout(() => {
                displayAIResult(title, mockContent);
                resetAIButton(btnId, originalIcon, originalText);
            }, 2500);
        }

        // ูุญุงูุงุฉ ุตูุงุบุฉ ุฃูุฑ ุงูุนูู
        function generateCommunicationDraft() {
            if (!currentSelectedObservation) return alert("ูุฑุฌู ุงุฎุชูุงุฑ ููุงุญุธุฉ ุฃููุงู.");
            
            setAILoading('comm-btn', 'ุฌุงุฑู ุงูุตูุงุบุฉ...');

            const draft = `
                <h4 style="font-weight: 700; color: #0A1931;">ุฃูุฑ ุนูู (Work Order)</h4>
                <p style="margin-bottom: 15px;">ุฅูู ูุฑูู ${currentSelectedObservation.type}ุ</p>
                <p>ูุฑุฌู ุงูุชูุฌูู ููุฑุงู ุฅูู ุงููููุน ุงูุชุงูู (${currentSelectedObservation.location}) ููุนุงูุฌุฉ ุงูููุงุญุธุฉ ุฑูู #${currentSelectedObservation.id} ุฐุงุช ุงูุฃููููุฉ ุงูุนุงููุฉ.</p>
                <p style="margin-top: 10px;">ูุตู ุงููุดููุฉ: ${currentSelectedObservation.description}</p>
                <p style="margin-top: 15px; font-weight: 700; color: #B91C1C;">ุงูููุงู ุงููุทููุจุฉ (ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู):</p>
                <ul style="list-style-type: 'โ๏ธ'; padding-right: 20px;">
                    <li>ูุนุงูุฌุฉ ุงูุณุจุจ ุงูุฌุฐุฑู ูุชุฌูุน ุงูููุงู.</li>
                    <li>ุชูุซูู ุงููููุน ูุจู ูุจุนุฏ ุงูุฅุตูุงุญ ุจุตูุฑ ุนุงููุฉ ุงูุฏูุฉ.</li>
                    <li>ุฅุบูุงู ุงูุจูุงุบ ุจุนุฏ ุงูุชุฃูุฏ ูู ุฌูุงู ุงูููุทูุฉ ุจุงููุงูู.</li>
                </ul>
                <p style="margin-top: 20px; font-style: italic; color: #0A1931;">- ูุธุงู Smart HSR ุงูุขูู</p>
            `;

            setTimeout(() => {
                displayAIResult('ูุณูุฏุฉ ุฃูุฑ ุนูู ุขูู', draft, 'comm');
                resetAIButton('comm-btn', 'send', 'ุตูุงุบุฉ ุฃูุฑ ุงูุนูู');
            }, 2500);
        }

        // ุฏุงูุฉ ูุญุงูุงุฉ ูุชูููุฏ ุชูุฑูุฑ PDF
        function generatePdfReport() {
            if (!currentSelectedObservation) return alert("ูุฑุฌู ุงุฎุชูุงุฑ ููุงุญุธุฉ ุฃููุงู ูุฅูุดุงุก ุชูุฑูุฑ PDF.");

            document.getElementById('printTitle').innerText = `ุชูุฑูุฑ ุงูููุงุญุธุฉ ุฑูู #${currentSelectedObservation.id} - ${currentSelectedObservation.title}`;
            window.print();
        }

        // =========================================================================
        // ๐ ุฏุงูุฉ ุงุฎุชูุงุฑ ูุนุฑุถ ุงูุชูุงุตูู (Show Observation Detail)
        // =========================================================================

        function showObservationDetail(id) {
            const observation = observationsData.find(obs => obs.id === id);
            if (!observation) return;

            currentSelectedObservation = observation;
            
            // ุชุญุฏูุซ ุญุงูุฉ ุงูุฃุฒุฑุงุฑ
            const isClosed = observation.status === 'ุชูุช ุงููุนุงูุฌุฉ';
            document.getElementById('completeObservationBtn').classList.toggle('hidden', isClosed);
            document.getElementById('updateStatusBtn').classList.toggle('hidden', isClosed);
            document.getElementById('alreadyCompletedBtn').classList.toggle('hidden', !isClosed);
            document.getElementById('actionButtons').classList.toggle('justify-end', !isClosed);
            
            // ุฅุฎูุงุก ุงูู Placeholder ูุฅุธูุงุฑ ุงูุชูุงุตูู
            document.getElementById('detailPlaceholder').classList.add('hidden');
            document.getElementById('observationDetail').classList.remove('hidden');

            // ุชุตููุฑ ูุชุงุฆุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุนูุฏ ุงูุชุจุฏูู
            document.getElementById('aiResultContainer').classList.add('hidden');
            document.getElementById('aiResultContent').innerText = '';

            // ุชุญุฏูุซ ุงูุชูุงุตูู ุงูุฃุณุงุณูุฉ
            document.getElementById('detailTitle').innerText = observation.title;
            document.getElementById('detailType').innerText = observation.type;
            document.getElementById('detailLocation').innerText = observation.location;
            document.getElementById('detailDate').innerText = observation.date;
            document.getElementById('detailDescription').innerText = observation.description;
            document.getElementById('detailID').innerText = observation.id;
            
            // ุชุญุฏูุซ ุงูุญุงูุฉ
            const statusEl = document.getElementById('detailStatus');
            statusEl.innerText = observation.status;
            statusEl.className = 'inline-block px-3 py-1 text-sm font-semibold rounded-full text-white';
            if (observation.status === 'ุชูุช ุงููุนุงูุฌุฉ') {
                statusEl.classList.add('bg-green-600');
            } else if (observation.status === 'ููุฏ ุงูุชูููุฐ') {
                statusEl.classList.add('bg-yellow-600');
            } else {
                statusEl.classList.add('bg-red-600');
            }

            // ุนุฑุถ ุงููุฑููุงุช
            const mediaContainer = document.getElementById('mediaContainer');
            const mediaContent = document.getElementById('mediaContent');
            const comparisonWrapper = document.getElementById('imageComparisonWrapper');
            const noImageMessage = document.getElementById('noImageMessage');

            // ุฅุฎูุงุก ูู ุงูุฎูุงุฑุงุช ุฃููุงู
            mediaContainer.classList.add('hidden');
            comparisonWrapper.classList.add('hidden');
            noImageMessage.classList.add('hidden');
            
            // ุฅุธูุงุฑ ุฃู ุฅุฎูุงุก ูุฐูุฑุฉ ุงูุฅุบูุงู
            document.getElementById('resolutionNoteContainer').classList.toggle('hidden', !isClosed);
            if (isClosed && observation.resolutionNote) {
                document.getElementById('resolutionNote').innerText = observation.resolutionNote;
            }

            // ุฅุธูุงุฑ ุฃู ุฅุฎูุงุก ุฎุทุฉ ุงูุนูู (ุงูุชุฑุงุถูุงู ุบูุฑ ููุฌูุฏุฉ ุงูุขู)
            document.getElementById('actionPlanContainer').classList.add('hidden'); 

            // ููุทู ุนุฑุถ ุงูุตูุฑ/ุงูููุฏูู ูุงูููุงุฑูุฉ
            if (observation.imageUrl && observation.imageUrl !== 'placeholder.jpg') {
                
                if (observation.isComparative && observation.afterImageUrl) {
                    // ุญุงูุฉ ุงูููุงุฑูุฉ (Before/After)
                    comparisonWrapper.classList.remove('hidden');
                    document.getElementById('beforeImage').src = observation.imageUrl;
                    
                    const afterImageContainer = document.getElementById('afterImageContainer');
                    afterImageContainer.innerHTML = '';
                    
                    // ุชุญูู ูู ููุน ุงูููู (ุตูุฑุฉ ุฃู ููุฏูู) ูู After Image
                    if (observation.afterImageUrl.match(/\.(mp4|webm|ogg)$/i)) {
                        afterImageContainer.innerHTML = `<video id="afterImage" class="w-full h-auto" controls src="${observation.afterImageUrl}"></video>`;
                    } else {
                        afterImageContainer.innerHTML = `<img id="afterImage" class="w-full h-auto" alt="ุตูุฑุฉ ุจุนุฏ ุงูุฅุตูุงุญ" src="${observation.afterImageUrl}">`;
                    }
                    
                    // ุชูุนูู ูุธููุฉ ุงูููุงุฑูุฉ
                    setupImageComparison();
                    
                } else {
                    // ุญุงูุฉ ุงูุตูุฑุฉ ุฃู ุงูููุฏูู ุงููุงุญุฏุฉ (Before only)
                    mediaContainer.classList.remove('hidden');
                    mediaContent.innerHTML = '';
                    
                    // ุชุญูู ูู ููุน ุงูููู
                    if (observation.imageUrl.match(/\.(mp4|webm|ogg)$/i)) {
                        mediaContent.innerHTML = `<video class="w-full h-auto rounded-xl" controls src="${observation.imageUrl}"></video>`;
                    } else {
                        mediaContent.innerHTML = `<img class="w-full h-auto rounded-xl" alt="ูุฑูู ุงูููุงุญุธุฉ" src="${observation.imageUrl}">`;
                    }
                }
            } else {
                // ุญุงูุฉ ูุง ููุฌุฏ ูุฑูู
                noImageMessage.classList.remove('hidden');
            }

            // ุชุญุฏูุซ ุญุงูุฉ ุงูุนูุงุตุฑ ูู ุงููุงุฆูุฉ
            document.querySelectorAll('.observation-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`.observation-item[data-id="${id}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }

            lucide.createIcons();
        }


        // =========================================================================
        // ๐ ุฏุงูุฉ ุงูุชุตููุฉ (Filter)
        // =========================================================================

        function handleFilterChange() {
            const filterValue = document.getElementById('observationFilter').value;
            let filteredData;

            if (filterValue === 'ุงููู') {
                filteredData = observationsData;
            } else if (['ุฌุฏูุฏ', 'ููุฏ ุงูุชูููุฐ', 'ุชูุช ุงููุนุงูุฌุฉ'].includes(filterValue)) {
                filteredData = observationsData.filter(obs => obs.status === filterValue);
            } else {
                filteredData = observationsData.filter(obs => obs.type === filterValue);
            }

            renderObservationsList(filteredData);
            
            if (filteredData.length === 0) {
                document.getElementById('observationDetail').classList.add('hidden');
                document.getElementById('detailPlaceholder').classList.remove('hidden');
                currentSelectedObservation = null;
            } else {
                currentSelectedObservation = filteredData[0];
                showObservationDetail(currentSelectedObservation.id);
            }
        }
        
        // =========================================================================
        // --- Initialization ---
        // =========================================================================

        function calculateAndRenderAll() {
            calculateKPIs();
            renderKPIs();
            
            if (observationsData.length > 0) {
                observationsData.sort((a, b) => b.createdAt - a.createdAt);
                renderObservationsList(observationsData);

                currentSelectedObservation = currentSelectedObservation || observationsData[0];
                showObservationDetail(currentSelectedObservation.id);
            } else {
                renderObservationsList([]);
                document.getElementById('observationDetail').classList.add('hidden');
                document.getElementById('detailPlaceholder').classList.remove('hidden');
            }
        }

        function initApp() {
            calculateAndRenderAll();
            lucide.createIcons();
        }

        // ๐ ุงูุจุฏุก ุนูุฏ ุชุญููู ุงูุตูุญุฉ ุจุงููุงูู
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>
