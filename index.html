<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart HSR | ููุญุฉ ุงูููุงุฏุฉ ุงูุชูููุฐูุฉ - ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู</title>
    
    <meta name="description" content="ูุธุงู Smart HSR ูููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู - ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
    <meta name="keywords" content="Smart HSR, ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ, ูุธุงู ุงููุฑุงูุจุฉ, ููุญุฉ ุชุญูู, ุงูุฐูุงุก ุงูุงุตุทูุงุนู, ุชุญููู ุงูุจูุงูุงุช">
    <meta name="author" content="Smart HSR">
    <meta name="robots" content="index, follow">
    
    <meta property="og:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
    <meta property="og:description" content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_SA">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Smart HSR | ูุธุงู ุงููุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุฑููู">
    <meta name="twitter:description" content="ููุญุฉ ุชุญูู ุชูููุฐูุฉ ูุชูุฏูุฉ ูุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ ูุชุญููู ุงูุจูุงูุงุช ุจุชูููุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
    
    <link rel="icon" type="image/svg+xml" href="favicon.svg"> 
    <link rel="stylesheet" href="output.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
</head>

<body onload="initApp()">

    <script>
        // **********************************************
        // 1. ุฅุนุฏุงุฏุงุช Firebase (ุชู ุชุญุฏูุซ ุงูููุชุงุญ ููุท)
        // **********************************************
        const firebaseConfigLite = {
            apiKey: "AIzaSyC5HTAq-LeJn4GObn08REwKdqIeokKmwds", // ๐ ุชู ุงูุชุญุฏูุซ ุจุงูููุชุงุญ ุงููุฑุณู
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfigLite);
        }

        // ูุญุต ุญุงูุฉ ุงููุตุงุฏูุฉ (ูุญุงูุงุฉ)
        const userLoggedIn = localStorage.getItem('userIsLoggedIn') === 'true';

        // ุฅุฐุง ูุงู ุงูุฎุงุฏู ูู ููู ุจุฅุนุงุฏุฉ ุงูุชูุฌูู (ุฃู ูุบุฑุถ ุงูุชุทููุฑ)ุ ููุญุต ููุง
        firebase.auth().onAuthStateChanged((user) => {
            if (!user && !userLoggedIn) {
                // ููุณ ูุณุฌูุงู ุฏุฎูููุ ุฃุนุฏ ุงูุชูุฌูู ูุตูุญุฉ ุงูุฏุฎูู
                window.location.href = 'login.html';
            } else {
                // ูุณุฌู ุฏุฎูููุ ุฅุฒุงูุฉ ูุญุงูุงุฉ ุงูุฌูุณุฉ ุจุนุฏ ุชุฃููุฏ Firebase
                localStorage.removeItem('userIsLoggedIn'); 
            }
        });
    </script>


    <div class="flex h-screen bg-gray-50 main-content">
        <div class="w-20 md:w-64 bg-[--color-navy] text-white flex flex-col no-print">
            <div class="p-4 flex items-center justify-center md:justify-start border-b border-teal-700">
                <span data-lucide="monitor" class="w-8 h-8 text-teal-400"></span>
                <span class="hidden md:block text-2xl font-bold mr-2 ml-4">Smart HSR</span>
            </div>

            <nav class="flex-grow p-4">
                <ul>
                    <li class="mb-2">
                        <a href="index.html" class="flex items-center p-3 rounded-lg bg-teal-700 text-white font-semibold shadow-md transition duration-150 hover:bg-teal-600">
                            <span data-lucide="layout-dashboard" class="w-6 h-6 ml-3"></span>
                            <span class="hidden md:block">ููุญุฉ ุงูููุงุฏุฉ</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="flex items-center p-3 rounded-lg text-gray-300 transition duration-150 hover:bg-gray-800 hover:text-white">
                            <span data-lucide="file-text" class="w-6 h-6 ml-3"></span>
                            <span class="hidden md:block">ุงูุชูุงุฑูุฑ</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="flex items-center p-3 rounded-lg text-gray-300 transition duration-150 hover:bg-gray-800 hover:text-white">
                            <span data-lucide="settings" class="w-6 h-6 ml-3"></span>
                            <span class="hidden md:block">ุงูุฅุนุฏุงุฏุงุช</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="p-4 border-t border-teal-700">
                <button onclick="signOutUser()" class="w-full flex items-center justify-center md:justify-start p-3 rounded-lg text-red-400 transition duration-150 hover:bg-gray-800 hover:text-red-300">
                    <span data-lucide="log-out" class="w-6 h-6 ml-3"></span>
                    <span class="hidden md:block font-semibold">ุชุณุฌูู ุงูุฎุฑูุฌ</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-auto bg-gray-50">
            <header class="bg-white shadow-md p-4 flex justify-between items-center no-print">
                <h1 class="text-2xl font-bold text-gray-800">ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูุฌูุฏุฉ</h1>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button onclick="window.print()" class="text-gray-600 hover:text-teal-600 transition duration-150 p-2 rounded-full hover:bg-gray-100" title="ุชูููุฏ ุชูุฑูุฑ PDF">
                        <span data-lucide="file-text" class="w-6 h-6"></span>
                    </button>
                    <button class="text-gray-600 hover:text-teal-600 transition duration-150 p-2 rounded-full hover:bg-gray-100" title="ุงูุฅุดุนุงุฑุงุช">
                        <span data-lucide="bell" class="w-6 h-6"></span>
                    </button>
                    <img src="https://via.placeholder.com/40" alt="ุตูุฑุฉ ุงููุณุชุฎุฏู" class="w-10 h-10 rounded-full border-2 border-teal-600">
                </div>
            </header>

            <main class="p-4 md:p-8">
                <section class="mb-8">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 no-print">ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ (KPIs)</h2>
                    <div id="kpis-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        </div>
                </section>
                
                <section class="mb-8 p-6 bg-white rounded-xl shadow-lg border-t-4 border-teal-600">
                    <div id="ai-insight-result">
                        <div class="flex items-center text-gray-500">
                            <span data-lucide="zap" class="w-5 h-5 ml-2 text-yellow-500"></span>
                            <p class="font-medium">ุงูุชุธุฑ ุญุชู ูููู ุงููุธุงู ุจุชุญููู ุงูุจูุงูุงุช ูุชูููุฏ ููุฎุต ุชูููุฐู...</p>
                        </div>
                    </div>
                </section>


                <section class="grid grid-cols-1 md:grid-cols-7 gap-6">
                    <div class="md:col-span-3 bg-white p-6 rounded-xl shadow-lg max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4 no-print">
                            <h2 class="text-xl font-bold text-gray-700">ูุงุฆูุฉ ุงูููุงุญุธุงุช ุงูููุฏุงููุฉ</h2>
                            <button onclick="resetFilters()" class="text-sm text-gray-500 hover:text-teal-600 transition duration-150">ุฅุนุงุฏุฉ ุชุนููู</button>
                        </div>

                        <div class="space-y-4 mb-6 no-print">
                            <div class="relative">
                                <span data-lucide="search" class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></span>
                                <input type="text" id="search-input" oninput="handleFilterChange()" placeholder="ุงุจุญุซ ุจุงูุฑูู ุฃู ุงููุณู..." class="w-full py-2 pr-10 pl-4 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                            </div>

                            <div class="flex space-x-4 space-x-reverse">
                                <select id="filter-status" onchange="handleFilterChange()" class="w-1/2 py-2 px-4 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 text-gray-700">
                                    <option value="">ุฌููุน ุงูุญุงูุงุช</option>
                                    <option value="open">ููุชูุญุฉ</option>
                                    <option value="closed">ูุบููุฉ</option>
                                    <option value="pending">ูุนููุฉ</option>
                                </select>
                                <select id="sort-by" onchange="handleFilterChange()" class="w-1/2 py-2 px-4 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 text-gray-700">
                                    <option value="newest">ุงูุฃุญุฏุซ ุฃููุงู</option>
                                    <option value="oldest">ุงูุฃูุฏู ุฃููุงู</option>
                                    <option value="priority">ุงูุฃููููุฉ</option>
                                </select>
                            </div>
                        </div>

                        <div id="observations-list" class="space-y-3">
                            </div>
                    </div>

                    <div id="observation-detail" class="md:col-span-4 bg-white p-6 rounded-xl shadow-lg observation-detail-card overflow-y-auto max-h-[80vh]">
                        <p class="text-center text-gray-500 py-16">ุงุฎุชุฑ ููุงุญุธุฉ ูู ุงููุงุฆูุฉ ูุนุฑุถ ุชูุงุตูููุง.</p>
                    </div>
                </section>

                <button id="scrollToTopBtn" onclick="scrollToTop()" class="no-print fixed bottom-8 right-8 bg-teal-600 text-white p-3 rounded-full shadow-lg transition duration-300 hover:bg-teal-700" title="ุงูุฑุฌูุน ููุฃุนูู" style="display: none;">
                    <span data-lucide="arrow-up" class="w-6 h-6"></span>
                </button>
            </main>
        </div>
    </div>


    <script>
        // --- DATA STRUCTURE (JSON) ---
        const observationsData = [
            { id: 1, title: 'ุชุขูู ูู ููุทุฉ ุฑุจุท ุงููุงุจู', section: 'ELECTRICAL', status: 'open', priority: 'high', createdAt: new Date(2024, 9, 5), closedAt: null, notes: 'ุชุขูู ูู ุนุงุฒู ุงููุงุจู ุจุงููุฑุจ ูู ุงููุญุทุฉ Aุ ูุชุทูุจ ุนุฒู ูุชุบููุฑ ููุฑู.', reporter: 'ุฃุญูุฏ ุงูุญุงุฑุซู', location: 'ุงููุญุทุฉ A - ุงููุณู ุงูููุฑุจุงุฆู', beforeImage: 'https://images.unsplash.com/photo-1589254884393-2747124f5a3e?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTR8fGVsZWN0cmljYWwlMjBkYW1hZ2V8ZW58MHx8MHx8fDA%3D', afterImage: null, isComparative: false },
            { id: 2, title: 'ุชุดููุงุช ูู ูุงุนุฏุฉ ุงูุณูุฉ', section: 'CIVIL', status: 'closed', priority: 'medium', createdAt: new Date(2024, 9, 1), closedAt: new Date(2024, 9, 3), notes: 'ุชุดููุงุช ุณุทุญูุฉ ูู ููุทุน ุฎุฑุณุงูู ุจุทูู 3 ุฃูุชุงุฑุ ุชู ุฅุตูุงุญู ุจุญูู ุงูุฅูุจููุณู.', reporter: 'ุณุงุฑุฉ ุงูุนุจุฏุงููู', location: 'ุงููุญุทุฉ C - ููุทุน 205', beforeImage: 'https://images.unsplash.com/photo-1549429177-380ff981c2f9?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTF8fGNvbmNyZXRlJTIwY3JhY2t8ZW58MHx8MHx8fDA%3D', afterImage: 'https://images.unsplash.com/photo-1550774619-3f0f9b6e8281?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTd8fGNvbmNyZXRlJTIwZml4ZWR8ZW58MHx8MHx8fDA%3D', isComparative: true },
            { id: 3, title: 'ุชูู ูู ุฅุดุงุฑุงุช ุงูุชุญุฐูุฑ', section: 'SIGNALING', status: 'pending', priority: 'high', createdAt: new Date(2024, 9, 8), closedAt: null, notes: 'ุฅุดุงุฑุฉ ุชุญุฐูุฑ ุถูุฆูุฉ ูู ููุทุน B ูุง ุชุนูู ุจุดูู ูุชูุทุน. ุชู ุทูุจ ูุทุนุฉ ุบูุงุฑ.', reporter: 'ุฎุงูุฏ ุงูุฒูุฑุงูู', location: 'ุงูููุทุน B - ุจุฑุฌ 12', beforeImage: 'https://images.unsplash.com/photo-1628108428359-54a8527a0d8e?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8ZmFpbGVkJTIwc2lnbmFsfGVufDB8fDB8fHww', afterImage: null, isComparative: false },
            { id: 4, title: 'ุฑุตุฏ ุฌุณู ุบุฑูุจ ุนูู ุงูุทุฑูู', section: 'INFRASTRUCTURE', status: 'open', priority: 'critical', createdAt: new Date(2024, 9, 10), closedAt: null, notes: 'ุชู ุฑุตุฏ ุญุทุงู ูุนุฏูู ูุจูุฑ ุนูู ุงููุณุงุฑ ุงูุณุฑูุน ุฑูู 1. ูุชุทูุจ ุฅุฒุงูุฉ ููุฑูุฉ ูุณูุงูุฉ ุงูุญุฑูุฉ.', reporter: 'ูุฑูู ุงููุฑุงูุจุฉ', location: 'ุงููุณุงุฑ ุงูุณุฑูุน 1 - ูููู 56', beforeImage: 'https://images.unsplash.com/photo-1563299797-09d4791523c1?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cmFpbHJvYWQlMjBkZWJyaXN8ZW58MHx8MHx8fDA%3D', afterImage: null, isComparative: false },
            { id: 5, title: 'ุชุขูู ุตุจุบ ุงูุญูุงูุฉ ูุนููุฏ ูุนุฏูู', section: 'MAINTENANCE', status: 'closed', priority: 'low', createdAt: new Date(2024, 8, 28), closedAt: new Date(2024, 9, 2), notes: 'ุชูุช ุฅุนุงุฏุฉ ุตุจุบ ุงูุนููุฏ ูุฅุถุงูุฉ ุทุจูุฉ ุญูุงูุฉ ุถุฏ ุงูุตุฏุฃ.', reporter: 'ูุงุฌุฏ ุงูุญุฑุจู', location: 'ุงูุฌุณุฑ ุฑูู 7', beforeImage: 'https://images.unsplash.com/photo-1566373703358-d15f02c6d482?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTJ8fHJ1c3R5JTIwbWV0YWx8ZW58MHx8MHx8fDA%3D', afterImage: 'https://images.unsplash.com/photo-1582215325983-503d21f83c0f?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MjB8fHBhaW50ZWR8ZW58MHx8MHx8fDA%3D', isComparative: true },
        ];

        let currentSelectedObservation = null;

        // --- CORE FUNCTIONS ---

        /**
         * ูุญุณุจ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ (KPIs) ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงูุญุงููุฉ.
         */
        function calculateKPIs(data = observationsData) {
            const now = new Date();
            const openReports = data.filter(obs => obs.status === 'open').length;
            const closedReports = data.filter(obs => obs.status === 'closed').length;
            const totalReports = data.length;

            // ุญุณุงุจ ูุชูุณุท ุฒูู ุงูุฅุบูุงู (ุจุงูุฃูุงู)
            const closedObservations = data.filter(obs => obs.status === 'closed' && obs.closedAt);
            const totalTimeSpan = closedObservations.reduce((sum, obs) => {
                const diffTime = obs.closedAt.getTime() - obs.createdAt.getTime();
                const diffDays = diffTime / (1000 * 60 * 60 * 24);
                return sum + diffDays;
            }, 0);

            const avgClosureTime = closedObservations.length > 0 ? (totalTimeSpan / closedObservations.length).toFixed(1) : 0;

            return {
                totalReports: totalReports,
                openReports: openReports,
                closedReports: closedReports,
                closureRate: totalReports > 0 ? ((closedReports / totalReports) * 100).toFixed(1) : 0,
                avgClosureTime: avgClosureTime
            };
        }

        /**
         * ูุฑุณู ุจุทุงูุงุช ูุคุดุฑุงุช ุงูุฃุฏุงุก ูู ุงููุงุฌูุฉ.
         */
        function renderKPIs() {
            const kpis = calculateKPIs();
            const container = document.getElementById('kpis-container');
            
            // ุงุณุชุฎุฏุงู ุงููุฆุงุช ุงููุฏูุฌุฉ ุงูุขู ูู output.css
            const kpiElements = [
                { title: 'ุฅุฌูุงูู ุงูููุงุญุธุงุช', value: kpis.totalReports, icon: 'list-checks', colorClass: 'kpi-average-gradient', unit: 'ููุงุญุธุฉ' },
                { title: 'ููุงุญุธุงุช ููุชูุญุฉ', value: kpis.openReports, icon: 'alert-triangle', colorClass: 'kpi-open-gradient', unit: 'ููุงุญุธุฉ' },
                { title: 'ููุงุญุธุงุช ูุบููุฉ', value: kpis.closedReports, icon: 'check-circle', colorClass: 'kpi-closed-gradient', unit: 'ููุงุญุธุฉ' },
                { title: 'ูุชูุณุท ุฒูู ุงูุฅุบูุงู', value: kpis.avgClosureTime, icon: 'clock', colorClass: 'kpi-average-gradient', unit: 'ููู' }
            ];

            container.innerHTML = kpiElements.map(kpi => `
                <div class="kpi-card-professional bg-white rounded-xl p-5 shadow-lg flex flex-col justify-between border-b-4 border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">${kpi.title}</p>
                            <span class="text-4xl font-extrabold text-gray-800">${kpi.value}</span>
                            <span class="text-gray-500 text-base">${kpi.unit}</span>
                        </div>
                        <div class="p-3 rounded-full ${kpi.colorClass} text-white">
                            <span data-lucide="${kpi.icon}" class="w-6 h-6"></span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // ุฅุถุงูุฉ ููุฎุต ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุจุนุฏ ุนุฑุถ KPIs
            renderAIInsight(kpis);
            lucide.createIcons();
        }

        /**
         * ูุฑุณู ูุงุฆูุฉ ุงูููุงุญุธุงุช ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงููููุชุฑุฉ.
         */
        function renderObservationsList(data) {
            const listContainer = document.getElementById('observations-list');
            if (data.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 pt-8">ูุง ุชูุฌุฏ ููุงุญุธุงุช ุชุทุงุจู ูุนุงููุฑ ุงูุชุตููุฉ ุงููุญุฏุฏุฉ.</p>';
                return;
            }

            listContainer.innerHTML = data.map(obs => {
                const statusColor = obs.status === 'open' ? 'text-red-600 bg-red-100' :
                                    obs.status === 'closed' ? 'text-green-600 bg-green-100' :
                                    'text-yellow-600 bg-yellow-100';
                
                const priorityColor = obs.priority === 'critical' ? 'bg-red-500' :
                                      obs.priority === 'high' ? 'bg-orange-500' :
                                      'bg-gray-500';

                return `
                    <div id="obs-card-${obs.id}" onclick="showObservationDetail(${obs.id})" 
                         class="observation-card p-4 border border-gray-200 rounded-lg cursor-pointer transition duration-150 hover:shadow-md hover:border-teal-500 bg-white">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColor}">${obs.status === 'open' ? 'ููุชูุญุฉ' : obs.status === 'closed' ? 'ูุบููุฉ' : 'ูุนููุฉ'}</span>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${priorityColor} text-white capitalize">${obs.priority}</span>
                        </div>
                        <h3 class="text-base font-bold text-gray-800 truncate">${obs.title}</h3>
                        <p class="text-sm text-gray-500 mt-1">#${obs.id} - ${obs.section}</p>
                    </div>
                `;
            }).join('');
            
            // ุชุญุฏูุฏ ุฃูู ููุงุญุธุฉ ุชููุงุฆูุงู ุฃู ุงูุชู ูุงูุช ูุญุฏุฏุฉ ุณุงุจูุงู
            if (!currentSelectedObservation && data.length > 0) {
                showObservationDetail(data[0].id);
            } else if (currentSelectedObservation) {
                // ุฅุฐุง ูุงูุช ุงูููุงุญุธุฉ ูุง ุชุฒุงู ููุฌูุฏุฉ ูู ุงููุงุฆูุฉ ุงููููุชุฑุฉุ ูู ุจุชุญุฏูุฏูุง
                const reselectedObs = data.find(obs => obs.id === currentSelectedObservation.id);
                if (reselectedObs) {
                     showObservationDetail(reselectedObs.id);
                } else if (data.length > 0) {
                    // ูุฅูุงุ ุงุฎุชุฑ ุงูููุงุญุธุฉ ุงูุฃููู
                    showObservationDetail(data[0].id);
                }
            } else {
                 document.getElementById('observation-detail').innerHTML = '<p class="text-center text-gray-500 py-16">ุงุฎุชุฑ ููุงุญุธุฉ ูู ุงููุงุฆูุฉ ูุนุฑุถ ุชูุงุตูููุง.</p>';
            }
        }

        /**
         * ูุนุฑุถ ุชูุงุตูู ููุงุญุธุฉ ูุญุฏุฏุฉ.
         */
        function showObservationDetail(id) {
            const obs = observationsData.find(o => o.id === id);
            if (!obs) return;

            currentSelectedObservation = obs;

            // ุฅุฒุงูุฉ ุงูุชุญุฏูุฏ ูู ุฌููุน ุงูุจุทุงูุงุช ูุฅุถุงูุฉ ุงูุชุญุฏูุฏ ููุจุทุงูุฉ ุงูุญุงููุฉ
            document.querySelectorAll('.observation-card').forEach(card => card.classList.remove('bg-teal-50', 'border-teal-600'));
            const selectedCard = document.getElementById(`obs-card-${id}`);
            if (selectedCard) {
                 selectedCard.classList.add('bg-teal-50', 'border-teal-600');
            }


            const detailContainer = document.getElementById('observation-detail');
            const statusColor = obs.status === 'open' ? 'text-red-600 bg-red-100' :
                                obs.status === 'closed' ? 'text-green-600 bg-green-100' :
                                'text-yellow-600 bg-yellow-100';

            const statusText = obs.status === 'open' ? 'ููุชูุญุฉ' : obs.status === 'closed' ? 'ูุบููุฉ' : 'ูุนููุฉ';
            
            detailContainer.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-extrabold text-gray-800">${obs.title} <span class="text-gray-500 text-lg font-medium">#${obs.id}</span></h2>
                    <span class="text-sm font-semibold px-3 py-1 rounded-full ${statusColor}">${statusText}</span>
                </div>

                <div class="grid grid-cols-2 gap-4 text-sm mb-6 pb-4 border-b">
                    <p><span class="font-medium text-gray-500">ุงููุณู:</span> <span class="font-bold text-teal-600">${obs.section}</span></p>
                    <p><span class="font-medium text-gray-500">ุงูุฃููููุฉ:</span> <span class="font-bold text-red-500 capitalize">${obs.priority}</span></p>
                    <p><span class="font-medium text-gray-500">ุงููููุน:</span> ${obs.location}</p>
                    <p><span class="font-medium text-gray-500">ุชุงุฑูุฎ ุงูุฅูุดุงุก:</span> ${obs.createdAt.toLocaleDateString('ar-SA')}</p>
                    ${obs.closedAt ? `<p><span class="font-medium text-gray-500">ุชุงุฑูุฎ ุงูุฅุบูุงู:</span> ${obs.closedAt.toLocaleDateString('ar-SA')}</p>` : ''}
                    <p class="col-span-2"><span class="font-medium text-gray-500">ุงูููุจููุบ:</span> ${obs.reporter}</p>
                </div>

                <h3 class="text-xl font-bold text-gray-700 mb-3">ูุตู ุงูููุงุญุธุฉ</h3>
                <p class="text-gray-600 mb-6">${obs.notes}</p>

                <div class="mb-8 p-4 bg-gray-50 rounded-lg no-print ai-actions-buttons">
                    <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center">
                        <span data-lucide="zap" class="w-5 h-5 ml-2 text-yellow-500"></span>
                        ุฃุฏูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุชูุฏูุฉ (AI)
                    </h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <button onclick="simulateAIAction('vision')" class="flex flex-col items-center p-3 rounded-lg bg-indigo-500 text-white text-xs font-semibold transition duration-150 hover:bg-indigo-600">
                            <span data-lucide="eye" class="w-5 h-5 mb-1"></span>
                            ุงูุฑุคูุฉ ุงูุญุงุณูุจูุฉ
                        </button>
                        <button onclick="simulateAIAction('rootcause')" class="flex flex-col items-center p-3 rounded-lg bg-[--color-maroon] text-white text-xs font-semibold transition duration-150 hover:bg-red-900">
                            <span data-lucide="microscope" class="w-5 h-5 mb-1"></span>
                            ุงูุณุจุจ ุงูุฌุฐุฑู
                        </button>
                        <button onclick="simulateAIAction('recommendation')" class="flex flex-col items-center p-3 rounded-lg bg-green-500 text-white text-xs font-semibold transition duration-150 hover:bg-green-600">
                            <span data-lucide="lightbulb" class="w-5 h-5 mb-1"></span>
                            ุชูุตูุงุช ุงูุฅุตูุงุญ
                        </button>
                        <button onclick="simulateAIAction('priority')" class="flex flex-col items-center p-3 rounded-lg bg-orange-500 text-white text-xs font-semibold transition duration-150 hover:bg-orange-600">
                            <span data-lucide="trending-up" class="w-5 h-5 mb-1"></span>
                            ุชุตููู ุงูุฃููููุฉ
                        </button>
                    </div>
                </div>

                <div id="ai-action-result" class="mb-6 p-4 border-r-4 border-yellow-500 bg-yellow-50 text-gray-700 font-medium hidden">
                    </div>

                ${obs.beforeImage ? `
                    <h3 class="text-xl font-bold text-gray-700 mb-3">${obs.isComparative ? 'ููุงุฑูุฉ ูุจู ูุจุนุฏ ุงูุฅุตูุงุญ' : 'ุตูุฑุฉ ุงูููุงุญุธุฉ'}</h3>
                    <div class="relative w-full overflow-hidden rounded-lg shadow-xl" style="max-height: 400px;">
                        ${obs.afterImage ? `
                            <div id="comparison-container" class="relative w-full h-full">
                                <img src="${obs.afterImage}" alt="After Repair" class="w-full h-full object-cover">
                                <div id="before-image-container" class="absolute top-0 left-0 h-full overflow-hidden pointer-events-none" style="width: 50%;">
                                    <img src="${obs.beforeImage}" alt="Before Repair" class="w-full h-full object-cover absolute top-0 left-0" style="width: 200%;">
                                </div>
                                <div id="slider-handle" class="absolute top-0 transform -translate-x-1/2 cursor-ew-resize bg-white shadow-lg p-1 rounded-full border-2 border-gray-400 no-print" style="left: 50%; height: 100%; width: 30px; display: flex; justify-content: center; align-items: center;">
                                    <span data-lucide="grip-vertical" class="w-4 h-4 text-gray-600"></span>
                                </div>
                            </div>
                        ` : `
                            <img src="${obs.beforeImage}" alt="Observation Image" class="w-full h-full object-cover">
                            <p class="text-xs text-gray-500 mt-2 text-center print-hidden-text">ุตูุฑุฉ ุงูููุงุญุธุฉ ูุจู ุงูุฅุตูุงุญ.</p>
                        `}
                    </div>
                ` : `<p class="text-gray-500">ูุง ุชูุฌุฏ ุตูุฑ ูุชุงุญุฉ ููุฐู ุงูููุงุญุธุฉ.</p>`}
            `;
            
            lucide.createIcons(); // ุฅุนุงุฏุฉ ุฑุณู ุงูุฃููููุงุช ุงูุฌุฏูุฏุฉ
            
            // ุชููุฆุฉ ุดุฑูุท ุงูููุงุฑูุฉ
            if (obs.isComparative && obs.afterImage) {
                 setupImageComparison();
            }
        }


        // --- EVENT HANDLERS AND HELPERS ---

        /**
         * ูุญุงูุงุฉ ูุธุงุฆู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
         */
        function simulateAIAction(actionType) {
            const resultBox = document.getElementById('ai-action-result');
            let resultText = '';
            let actionName = '';

            switch (actionType) {
                case 'vision':
                    actionName = 'ุงูุฑุคูุฉ ุงูุญุงุณูุจูุฉ';
                    resultText = `ุชุญููู AI: ุชู ุงูุชุฃูุฏ ูู ูุฌูุฏ ${currentSelectedObservation.section} (ูุณุจุฉ ุซูุฉ 98%). ุชู ุงูุชุดุงู ุฎูู ูู ${currentSelectedObservation.title} (ูุณุจุฉ ุซูุฉ 92%). ููุตุญ ุจุงูุชุญูู ุงูุจุดุฑู ุงูููุงุฆู.`;
                    break;
                case 'rootcause':
                    actionName = 'ุงูุณุจุจ ุงูุฌุฐุฑู';
                    resultText = `ุชุญููู AI ููุณุจุจ ุงูุฌุฐุฑู: ููุนุชูุฏ ุฃู ุงูุณุจุจ ุงูุฑุฆูุณู ูู ุนูุงูู ุงูุทูุณ (ุงูุฑุทูุจุฉ/ุงูุญุฑุงุฑุฉ) ูุงูุชุขูู ุงูุทุจูุนูุ ูุธุฑุงู ูุนุฏู ูุฌูุฏ ุชูุงุฑูุฑ ุณุงุจูุฉ ุนู ุฃุนุทุงู ููุงุซูุฉ ูู ูุฐู ุงูููุทูุฉ ุฎูุงู ุขุฎุฑ 6 ุฃุดูุฑ.`;
                    break;
                case 'recommendation':
                    actionName = 'ุชูุตูุงุช ุงูุฅุตูุงุญ';
                    resultText = `ุชูุตูุฉ AI: ุงูุฅุฌุฑุงุก ุงูููุฑู: ุนุฒู ุงูููุทูุฉ. ุงูุฅุฌุฑุงุก ุงููุทููุจ: ุงุณุชุจุฏุงู ุงูุฌุฒุก ุงููุชุขูู ุฃู ุฅุนุงุฏุฉ ุงูุทูุงุก ุจุทุจูุฉ ุญูุงูุฉ ุซูุงุซูุฉ. ุชูุฏูุฑ ุงูููุงุฏ: [500 ุฑูุงู]ุ ุชูุฏูุฑ ุงูููุช: [4 ุณุงุนุงุช].`;
                    break;
                case 'priority':
                    actionName = 'ุชุตููู ุงูุฃููููุฉ';
                    resultText = `ุชุตููู AI: ุชู ุชุตููู ุงูููุงุญุธุฉ ุนูู ุฃููุง **${currentSelectedObservation.priority.toUpperCase()}** ูุธุฑุงู ูุชุฃุซูุฑูุง ุงููุญุชูู ุนูู ุงูุณูุงูุฉ ุงูุชุดุบูููุฉ. ุงูุชูุตูุฉ: ุจุฏุก ุงูุนูู ุฎูุงู 24 ุณุงุนุฉ.`;
                    break;
            }

            resultBox.innerHTML = `
                <p class="font-bold text-lg text-yellow-700">${actionName} (ููุญุงูุงุฉ)</p>
                <p class="text-gray-700 mt-1">${resultText}</p>
            `;
            resultBox.classList.remove('hidden');
        }

        /**
         * ุชููุฆุฉ ุดุฑูุท ููุงุฑูุฉ ุงูุตูุฑ.
         */
        function setupImageComparison() {
            const container = document.getElementById('comparison-container');
            const before = document.getElementById('before-image-container');
            const slider = document.getElementById('slider-handle');

            if (!container || !before || !slider) return;

            let isDragging = false;

            const onMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();

                const rect = container.getBoundingClientRect();
                let x = (e.clientX || e.touches[0].clientX) - rect.left;

                if (x < 0) x = 0;
                if (x > rect.width) x = rect.width;

                const percent = (x / rect.width) * 100;
                before.style.width = `${percent}%`;
                slider.style.left = `${percent}%`;
            };

            const onStop = () => {
                isDragging = false;
                window.removeEventListener('mousemove', onMove);
                window.removeEventListener('mouseup', onStop);
                window.removeEventListener('touchmove', onMove);
                window.removeEventListener('touchend', onStop);
            };

            const onStart = (e) => {
                isDragging = true;
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onStop);
                window.addEventListener('touchmove', onMove);
                window.addEventListener('touchend', onStop);
                onMove(e); // ููุนุงูุฌุฉ ุงูููุฑ ุงูุฃููู
            };

            slider.addEventListener('mousedown', onStart);
            slider.addEventListener('touchstart', onStart);
            
            // ุถุจุท ุงูููุถุน ุงูุฃููู
            before.style.width = '50%';
            slider.style.left = '50%';
        }
        
        /**
         * ุชุทุจูู ุงูุชุตููุฉ ูุงููุฑุฒ ูุฅุนุงุฏุฉ ุฑุณู ุงููุงุฆูุฉ.
         */
        function handleFilterChange() {
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const sortBy = document.getElementById('sort-by').value;

            let filteredData = observationsData.filter(obs => {
                const searchMatch = obs.title.toLowerCase().includes(searchQuery) || 
                                    obs.section.toLowerCase().includes(searchQuery) ||
                                    obs.id.toString().includes(searchQuery);

                const statusMatch = !statusFilter || obs.status === statusFilter;

                return searchMatch && statusMatch;
            });

            // ุงููุฑุฒ
            if (sortBy === 'newest') {
                filteredData.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());
            } else if (sortBy === 'oldest') {
                filteredData.sort((a, b) => a.createdAt.getTime() - b.createdAt.getTime());
            } else if (sortBy === 'priority') {
                const priorityOrder = { 'critical': 4, 'high': 3, 'medium': 2, 'low': 1 };
                filteredData.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
            }

            renderObservationsList(filteredData);
        }
        
        /**
         * ุฅุนุงุฏุฉ ุชุนููู ุฃุฏูุงุช ุงูุชุตููุฉ.
         */
        function resetFilters() {
             document.getElementById('search-input').value = '';
             document.getElementById('filter-status').value = '';
             document.getElementById('sort-by').value = 'newest';
             handleFilterChange();
        }

        /**
         * ุชูููุฏ ููุฎุต ุชูููุฐู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู (ูุญุงูุงุฉ).
         */
        function renderAIInsight(kpis) {
            const openPercentage = kpis.totalReports > 0 ? ((kpis.openReports / kpis.totalReports) * 100).toFixed(0) : 0;
            
            document.getElementById('ai-insight-result').innerHTML = `
                <div class="kpi-insight-container p-4 mt-4 bg-white">
                    <p class="font-bold text-lg text-teal-700">ููุฎุต ุชูููุฐู ูููููุฏ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู:</p>
                    <p class="text-gray-700 mt-2">
                        ุชุธูุฑ ููุญุฉ ุงูุชุญูู ุฃู ููุงู **${kpis.openReports}** ููุงุญุธุงุช ููุชูุญุฉุ ููุง ูุดูู **${openPercentage}%** ูู ุฅุฌูุงูู ุงูููุงุญุธุงุช. 
                        ูุชูุณุท ุฒูู ุฅุบูุงู ุงูููุงุญุธุงุช ูู **${kpis.avgClosureTime} ููู**. 
                        ููุงู ุชุฑููุฒ ูู ูุณู <span class="font-bold text-red-600">INFRASTRUCTURE</span> ุจุณุจุจ ูุดููุฉ ุงูุทุฑูู ุงูุชู ุชู ุฅุฏุฎุงููุง ุญุฏูุซุงู. 
                        <br>ูุฌุจ ุนูู ุงููุฑูู ุงูุชูููุฐู ูุฑุงุฌุนุฉ ุฎุทุท ุงูุนูู ุงูููุฑูุฉ ูุชูููู ูุชูุณุท ุฒูู ุงูุฅุบูุงู ูุงูุชุฑููุฒ ุนูู ุชูุซูู ุฌููุน ุงูููุงุญุธุงุช ุจุงูุตูุฑ ูุถูุงู ุฌูุฏุฉ ุงูุฅุบูุงู.
                    </p>
                </div>
            `;
        }

        /**
         * ุชุณุฌูู ุงูุฎุฑูุฌ
         */
        function signOutUser() {
            // ูุญุงูุงุฉ ุชุณุฌูู ุงูุฎุฑูุฌ
            localStorage.removeItem('userIsLoggedIn'); 
            firebase.auth().signOut().then(() => {
                window.location.href = 'login.html';
            }).catch((error) => {
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุฎุฑูุฌ: " + error.message);
            });
        }
        
        /**
         * ุชููุฆุฉ ุงูุชุทุจูู ุนูุฏ ุงูุชุญููู.
         */
        function initApp() {
            // ูุชู ูุญุต ุงููุตุงุฏูุฉ ุฃููุงู ูู ุจุฏุงูุฉ ุงูู body
            // ูุฅุฐุง ูุงู ูุณุฌู ุฏุฎูููุ ูููู ุจุชุญููู ุงููุงุฌูุฉ
            calculateKPIs();
            renderKPIs();
            observationsData.sort((a, b) => b.createdAt - a.createdAt);
            renderObservationsList(observationsData);
            
            // ุนุฑุถ ุฃูู ููุงุญุธุฉ ุชูุตูููุงู ุงูุชุฑุงุถูุงู
            if (observationsData.length > 0) {
                 showObservationDetail(observationsData[0].id);
            }

            // ุชููุฆุฉ ุฒุฑ ุงูุฑุฌูุน ููุฃุนูู
            window.onscroll = function() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    document.getElementById("scrollToTopBtn").style.display = "block";
                } else {
                    document.getElementById("scrollToTopBtn").style.display = "none";
                }
            };
            
            lucide.createIcons(); 
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

    </script>
</body>
</html>
